---
title: "Evenness-Productivity Project"
author: "Iris Hordijk"
date: "01/07/2021"
output: html_document
---
###Load packages
```{r Packages}
library(vegan)
library(vcdExtra)
library(stats)
library(car)
library(gam)
library(datasets)
library(data.table)
library(sads)
library(tidyr)
library(tidyverse)
library(codyn)
library(ggplot2)
library(ggExtra)
library(raster)
library(sp)
library(maps)
library(ggmap)
library(maptools)
library(rgdal)
library(ggalt)
library(graphics)
library(gridExtra)
library(see)
library(patchwork)
library(performance)
library(relaimpo)
library(dplyr)
```
###Calculate richness and evenness from GFBI database (iMac)
```{r Script iMac}
#AFRICA
setwd("/Users/Shared") #Upload data 
Africa <- fread("/Users/Shared/GFBI_Data/GFBI_Species_Matrices/Species_Matrices_Originals/Africa_abM06282017.csv")
Africa_species <- as.data.frame(Africa[,9:3559])

###Calculate evenness indices
S <-specnumber(Africa_species) #Species richness
Diversity <- diversity(Africa_species) #Diversity
H1 <-exp(diversity(Africa_species))/S #Hill ratio 1/0
H1Stand <- (exp(diversity(Africa_species))-1)/(S-1)
Simpson <- diversity(Africa_species, index = "invsimpson")/S #Simpson evenness
PIE <- 1-diversity(Africa_species, index = "simpson")

Africa_plot <- as.data.frame(Africa[,1])
Africa_speciesPlot <- cbind(Africa_plot, Africa_species)
head(colnames(Africa_speciesPlot))
tail(colnames(Africa_speciesPlot))
Africa_speciesPlotgather <- gather(Africa_speciesPlot, Species, Abundance, "Aapaca sppNosymang1":"Ziziphus mucronata")
Africa_speciesPlotOmit <- subset(Africa_speciesPlotgather, Abundance!=0)
summary(Africa_speciesPlotOmit$Abundance)

EqCalc <- community_structure(Africa_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="EQ")
Eq <- EqCalc$EQ
EvarCalc <- community_structure(Africa_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="Evar")
Evar <- EvarCalc$Evar

#Combining data Lat, Long, S, E
Long <- Africa$Coords_x
Lat <- Africa$Coords_y
Year <- Africa$Yr
Plotsize <- Africa$Ps
TreesPerHa <- rowSums(Africa_species)/Plotsize

Africa_evenness <- cbind.data.frame(Lat, Long, Year, Plotsize, TreesPerHa, S, Diversity, H1, H1Stand, Simpson, Evar, PIE, Eq)
#sum(is.na(Africa_evenness))
rm(list=setdiff(ls(), "Africa_evenness"))

#OCEANIA
Oceania <- fread("/Users/Shared/GFBI_Data/GFBI_Species_Matrices/Species_Matrices_Originals/Oceania_abM07012017.csv") #Upload data 
Oceania_species <- as.data.frame(Oceania[,9:2419])

###Calculate evenness indices
S <-specnumber(Oceania_species) #Species richness
Diversity <- diversity(Oceania_species) #Diversity
H1<-exp(diversity(Oceania_species))/S #Hill ratio 1/0
H1Stand <- (exp(diversity(Oceania_species))-1)/(S-1)
Simpson <- diversity(Oceania_species, index = "invsimpson")/S #Simpson evenness
PIE <- 1-diversity(Oceania_species, index = "simpson")

Oceania_plot <- as.data.frame(Oceania[,1])
Oceania_speciesPlot <- cbind(Oceania_plot, Oceania_species)
head(colnames(Oceania_speciesPlot))
tail(colnames(Oceania_speciesPlot))
Oceania_speciesPlotgather <- gather(Oceania_speciesPlot, Species, Abundance, "Acacia aneura":"Zygogynum stipitatum")
Oceania_speciesPlotOmit <- subset(Oceania_speciesPlotgather, Abundance!=0)
summary(Oceania_speciesPlotOmit$Abundance)

EqCalc <- community_structure(Oceania_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="EQ")
Eq <- EqCalc$EQ
EvarCalc <- community_structure(Oceania_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="Evar")
Evar <- EvarCalc$Evar

#Combining data Lat, Long, S, E
Long <- Oceania$Coords_x
Lat <- Oceania$Coords_y
Year <- Oceania$Yr
Plotsize <- Oceania$Ps
TreesPerHa <- rowSums(Oceania_species)/Plotsize

Oceania_evenness <- cbind.data.frame(Lat, Long, Year, Plotsize, TreesPerHa, S, Diversity, H1, H1Stand, Simpson, Evar, PIE, Eq)
#sum(is.na(Oceania_evenness))
rm(list=setdiff(ls(), c("Africa_evenness", "Oceania_evenness")))

#South and Central America
SCAmerica <- fread("/Users/Shared/GFBI_Data/GFBI_Species_Matrices/Species_Matrices_Originals/SCAmerica_abM06282017.csv") #Upload data 
SCAmerica_species <- as.data.frame(SCAmerica[,9:17055])

###Calculate evenness indices
S <-specnumber(SCAmerica_species) #Species richness
Diversity <- diversity(SCAmerica_species) #Diversity
H1<-exp(diversity(SCAmerica_species))/S #Hill ratio 1/0
H1Stand <- (exp(diversity(SCAmerica_species))-1)/(S-1)
Simpson <- diversity(SCAmerica_species, index = "invsimpson")/S #Simpson evenness
PIE <- 1-diversity(SCAmerica_species, index = "simpson")

SCAmerica_plot <- as.data.frame(SCAmerica[,1])
SCAmerica_speciesPlot <- cbind(SCAmerica_plot, SCAmerica_species)
head(colnames(SCAmerica_speciesPlot))
tail(colnames(SCAmerica_speciesPlot))
SCAmerica_speciesPlotgather <- gather(SCAmerica_speciesPlot, Species, Abundance, "Abarema  sppTEAM2":"Zygia unifoliolata")
SCAmerica_speciesPlotOmit <- subset(SCAmerica_speciesPlotgather, Abundance!=0)
summary(SCAmerica_speciesPlotOmit$Abundance)

EqCalc <- community_structure(SCAmerica_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="EQ")
Eq <- EqCalc$EQ
EvarCalc <- community_structure(SCAmerica_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="Evar")
Evar <- EvarCalc$Evar

#Combining data Lat, Long, S, E
Long <- SCAmerica$Coords_x
Lat <- SCAmerica$Coords_y
Year <- SCAmerica$Yr
Plotsize <- SCAmerica$Ps
TreesPerHa <- rowSums(SCAmerica_species)/Plotsize

SCAmerica_evenness <- cbind.data.frame(Lat, Long, Year, Plotsize, TreesPerHa, S, Diversity, H1, H1Stand, Simpson, Evar, PIE, Eq)
#sum(is.na(SCAmerica_evenness))
rm(list=setdiff(ls(), c("Africa_evenness", "Oceania_evenness", "SCAmerica_evenness")))

#Eurasia
Eurasia <- fread("/Users/Shared/GFBI_Data/GFBI_Species_Matrices/Species_Matrices_Originals/Eurasia_abM07012017.csv") #Upload data 
Eurasia_species <- as.data.frame(Eurasia[,9:4396])

###Calculate evenness indices
S <-specnumber(Eurasia_species) #Species richness
Diversity <- diversity(Eurasia_species) #Diversity
H1<-exp(diversity(Eurasia_species))/S #Hill ratio 1/0
H1Stand <- (exp(diversity(Eurasia_species))-1)/(S-1)
Simpson <- diversity(Eurasia_species, index = "invsimpson")/S #Simpson evenness
PIE <- 1-diversity(Eurasia_species, index = "simpson")

Eurasia_plot <- as.data.frame(Eurasia[,1])
Eurasia_speciesPlot <- cbind(Eurasia_plot, Eurasia_species)
head(colnames(Eurasia_speciesPlot))
tail(colnames(Eurasia_speciesPlot))
Eurasia_speciesPlotgather <- gather(Eurasia_speciesPlot, Species, Abundance, "Abies alba":"Zuccarinia macrophylla")
Eurasia_speciesPlotOmit <- subset(Eurasia_speciesPlotgather, Abundance!=0)
summary(Eurasia_speciesPlotOmit$Abundance)

EqCalc <- community_structure(Eurasia_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="EQ")
Eq <- EqCalc$EQ
EvarCalc <- community_structure(Eurasia_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="Evar")
Evar <- EvarCalc$Evar

#Combining data Lat, Long, S, E
Long <- Eurasia$Coords_x
Lat <- Eurasia$Coords_y
Year <- Eurasia$Yr
Plotsize <- Eurasia$Ps
TreesPerHa <- rowSums(Eurasia_species)/Plotsize

Eurasia_evenness <- cbind.data.frame(Lat, Long, Year, Plotsize, TreesPerHa, S, Diversity, H1, H1Stand, Simpson, Evar, PIE, Eq)
#sum(is.na(Eurasia_evenness))
rm(list=setdiff(ls(), c("Africa_evenness", "Oceania_evenness", "SCAmerica_evenness", "Eurasia_evenness")))

#NAmerica
NAmerica <- fread("/Users/Shared/GFBI_Data/GFBI_Species_Matrices/Species_Matrices_Originals/NAmerica_abM06302017.csv") #Upload data 
NAmerica_species <- as.data.frame(NAmerica[,9:1882])

###Calculate evenness indices
S <-specnumber(NAmerica_species) #Species richness
Diversity <- diversity(NAmerica_species) #Diversity
H1<-exp(diversity(NAmerica_species))/S #Hill ratio 1/0
H1Stand <- (exp(diversity(NAmerica_species))-1)/(S-1)
Simpson <- diversity(NAmerica_species, index = "invsimpson")/S #Simpson evenness
PIE <- 1-diversity(NAmerica_species, index = "simpson")

NAmerica_plot <- as.data.frame(NAmerica[,1])
NAmerica_speciesPlot <- cbind(NAmerica_plot, NAmerica_species)
head(colnames(NAmerica_speciesPlot))
tail(colnames(NAmerica_speciesPlot))
NAmerica_speciesPlotgather <- gather(NAmerica_speciesPlot, Species, Abundance, "Abies.amabilis":"Zuelania.guidonia")
NAmerica_speciesPlotOmit <- subset(NAmerica_speciesPlotgather, Abundance!=0)
summary(NAmerica_speciesPlotOmit$Abundance)

EqCalc <- community_structure(NAmerica_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="EQ")
Eq <- EqCalc$EQ
EvarCalc <- community_structure(NAmerica_speciesPlotOmit, time.var="V1", abundance.var="Abundance", metric="Evar")
Evar <- EvarCalc$Evar

#Combining data Lat, Long, S, E
Long <- NAmerica$Coords_x
Lat <- NAmerica$Coords_y
Year <- NAmerica$Yr
Plotsize <- NAmerica$Ps
TreesPerHa <- rowSums(NAmerica_species)/Plotsize

NAmerica_evenness <- cbind.data.frame(Lat, Long, Year, Plotsize, TreesPerHa, S, Diversity, H1, H1Stand, Simpson, Evar, PIE, Eq)
#sum(is.na(NAmerica_evenness))
rm(list=setdiff(ls(), c("Africa_evenness", "Oceania_evenness", "SCAmerica_evenness", "Eurasia_evenness", "NAmerica_evenness")))

Global_evenness <- rbind(Africa_evenness, Oceania_evenness, SCAmerica_evenness, Eurasia_evenness, NAmerica_evenness)
dim(Global_evenness)
Global_evenness$ID <- seq.int(nrow(Global_evenness))
names(Global_evenness)
dim(Global_evenness)

setwd("/Volumes/CrowtherLabRAID/Iris/Data")
fwrite(Global_evenness, file= "Global_evenness20112021.csv")
```
###Filter plots based on plotsize
```{r Filter data}
setwd("~/Documents/PhD projects/Biomass") ###Load data
evenness_diversity <- fread("~/Documents/PhD projects/Biomass/Global_evenness20112021.csv") 
setnames(evenness_diversity, old = c("ID"), new = c("Plot_ID"))

LargePlotsizes <- evenness_diversity[ which(Plotsize > 1.5),]
SmallPlotsizes <- evenness_diversity[ which(Plotsize < 0.02),]
FinalPlotsizes <- evenness_diversity[ which(Plotsize < 1.5 & Plotsize > 0.02),]

###Calculate correlation and r2 between evenness and plotsize
cor.test(log(LargePlotsizes$S), LargePlotsizes$Plotsize, method="pearson")
cor.test(LargePlotsizes$H1, LargePlotsizes$Plotsize, method="pearson")
summary(lm(LargePlotsizes$H1 ~ LargePlotsizes$Plotsize))

cor.test(log(SmallPlotsizes$S), SmallPlotsizes$Plotsize, method="pearson")
cor.test(SmallPlotsizes$H1, SmallPlotsizes$Plotsize, method="pearson")
summary(lm(log(SmallPlotsizes$S) ~ SmallPlotsizes$Plotsize))

cor.test(log(FinalPlotsizes$S), FinalPlotsizes$Plotsize, method="pearson")
cor.test(FinalPlotsizes$H1, FinalPlotsizes$Plotsize, method="pearson")
summary(lm(FinalPlotsizes$H1 ~ FinalPlotsizes$Plotsize))

```
###Add data from composites: environmental variables, human impact and forest age
```{r Composites}

# #Create coordinates to extract info biomes, composites and forest reserves GEE
# evenness_diversity_ID <- evenness_diversity[, c("Lat", "Long", "Plot_ID")]
# write.csv(evenness_diversity_ID, file="evenness_diversity_ID.csv")

#Import Environmental variables from GEE
setwd("~/Documents/PhD projects/Biomass/20190403_Iris_Evenness_diversity")
Composite_files <- list.files("~/Documents/PhD projects/Biomass/20190403_Iris_Evenness_diversity") 
Composite_data <- as.data.frame(do.call(rbind,lapply(Composite_files, fread)))

#Add biomes from GEE
Biomes <- fread("~/Documents/PhD projects/Biomass/Evenness_biomes.csv")
setnames(Biomes, old="first", new="Biome")
Biomes <- Biomes[, c("Plot_ID", "Biome")]

#Add Human impact
setwd("~/Documents/PhD projects/Biomass/20191127_Productivity_HumanImpact")
HI_files <- list.files("~/Documents/PhD projects/Biomass/20191127_Productivity_HumanImpact") 
HI_data <- as.data.frame(do.call(rbind,lapply(HI_files, fread)))
Human_impact <- HI_data[, c("Human_Development_Percentage", "Population_Density", "Plot_ID")]

#Add Forest age 
setwd("~/Documents/PhD projects/Biomass/20200820_NPP_ForestAge")
ForestAge_files <- list.files("~/Documents/PhD projects/Biomass/20200820_NPP_ForestAge") 
ForestAge <- as.data.frame(do.call(rbind,lapply(ForestAge_files, read.csv)))
ForestAge <- ForestAge[, c( "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "Plot_ID")]

#Add Calculated NPP 
setwd("~/Documents/PhD projects/Biomass/NPP_12-03-2021")
NPP_files <- list.files("~/Documents/PhD projects/Biomass/NPP_12-03-2021") 
NPP_data <- as.data.frame(do.call(rbind,lapply(NPP_files, fread)))
setnames(NPP_data, old="first", new="NPP_calculated")
NPP_data <- NPP_data[, c("Plot_ID", "NPP_calculated")]

Merge_data <- list(FinalPlotsizes, Composite_data, Biomes, ForestAge, NPP_data, Human_impact) %>% reduce(left_join, by = "Plot_ID")
names(Merge_data)
setnames(Merge_data, old = c("system:index", "Lat.x", "Long.x"), new = c("system_index", "Lat", "Long"))

Composite_NPP <- subset(Merge_data, select= -c(Lat.y, Long.y, field_1, random, .geo, Npp, field_1, .geo, random, system_index))
setnames(Composite_NPP, old = c("NPP_calculated"), new = c("Npp"))

```
###Filter NPP based on tree density and measurement year
```{r Filter NPP, tree density and measurement year}

#Filter NPP, tree density and measurement year
Productivity <- Composite_NPP[complete.cases(Composite_NPP$Npp), ] 
ProductivityFilter <- Productivity %>% group_by(Biome) %>% filter(Npp > (mean(Npp) - 2*(sd(Npp))) & Npp < (mean(Npp) + 2*(sd(Npp)))) 

ProductivityFinal <- ProductivityFilter[which(ProductivityFilter$Year >= "1980" & ProductivityFilter$Year < "2020"),]
dim(ProductivityFinal)

mean(ProductivityFinal$Year)
min(ProductivityFinal$Year)
max(ProductivityFinal$Year)

mean(ProductivityFinal$GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=TRUE)
sd(ProductivityFinal$GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=TRUE)

setwd("~/Documents/PhD projects/Biomass")
fwrite(ProductivityFinal, file="NPP_24.11.2021.csv")

```

###Filter Biomass data on measurement year
```{r Filter Biomass, measurement year & outliers}
#The code for the biomass calculations will be uploaded shortly

Biomass <- fread("~/Documents/PhD projects/Biomass/biomass_evenness_ModelInput28112019.csv")
Biomass <- Biomass[, -c(1)]

#Get forest age data
CoordinatesBiomass20.08.2020 <- Biomass[, c("Lat", "Long", "Plot_ID")]

setwd("~/Desktop/")
fwrite(CoordinatesBiomass20.08.2020, file = "CoordinatesBiomass20.08.2020.csv")

setwd("~/Documents/PhD projects/Biomass/20200820_Biomass_ForestAge")
Composite_files <- list.files("~/Documents/PhD projects/Biomass/20200820_Biomass_ForestAge") 
ForestAge <- do.call(rbind,lapply(Composite_files, fread))
setnames(ForestAge, old = c("GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "Plot_ID" ), new = c("SecondaryForest", "ForestAge", "ID"))
ForestAge <- ForestAge[, c("SecondaryForest", "ForestAge", "ID")]

ForestAge <- ForestAge[order(ID),] 
Biomass <- Biomass[order(Plot_ID),]

Biomass_ForestAge <- cbind(Biomass, ForestAge)
a <- Biomass_ForestAge$Plot_ID - Biomass_ForestAge$ID
summary(a)

#Select 95% of data per biome, to get rid of outliers
Biomass <- Biomass_ForestAge %>% group_by(WWFBiome) %>% filter(biomassDensity > (mean(biomassDensity) - 2*(sd(biomassDensity)))
                                                     & biomassDensity < (mean(biomassDensity) + 2*(sd(biomassDensity)))) 

Biomass <- filter(Biomass, biomassDensity<1000000)
Biomass <- Biomass[complete.cases(Biomass$ForestAge), ] 
Biomass <- as.data.frame(Biomass)

Biomass$BiomassYr <- Biomass$biomassDensity/Biomass$ForestAge  
Biomass <-Biomass %>% filter_if(~is.numeric(.), all_vars(!is.infinite(.)))

Biomass <- Biomass[complete.cases(Biomass$BiomassYr), ] 
Biomass <- Biomass[,-c("random",".geo", "sdBiomass", "sdDBH","meanWoodDensity","sdWoodDensity", "V1", "system:index", "ID")]

#Filter measurements before 1980
Biomass <- Biomass[which(YEAR >= "1980"),]
dim(Biomass)
table(Biomass$WWFBiome)

setwd("~/Documents/PhD projects/Biomass")
fwrite(Biomass, file = "Biomass20.08.2020.csv")
```
###Map of datapoints Fig.2
```{r Map datapoints}

ProductivityFinal <- fread("~/Documents/PhD projects/Biomass/NPP_24.11.2021.csv")

###Fig. 2A
#load map
world <- map_data("world")
map <- ggplot() + geom_map(data=world, map=world, (aes(x=long, y=lat, map_id = region)),color=NA,fill="white")
map1 <- map + theme(panel.background = element_rect(fill = "grey80", colour=NA),panel.grid.major = element_line(colour = NA, size=0.01),panel.grid.minor = element_line(colour = NA, size=0.01))

#plot points on map, coloured by density
Coordinates_NPP <- ProductivityFinal[, c("Lat", "Long")]

Coordinates_NPP$dens <- col2rgb(densCols(Coordinates_NPP$Lat, Coordinates_NPP$Long))[1,] + 1L
paletteForUse <- c('#d10000', '#ff6622', '#ffda21', '#33dd00', '#1133cc', '#220066', '#330044')
colors <-  colorRampPalette(paletteForUse)(256)
Coordinates_NPP$colors = colors[Coordinates_NPP$dens]

map <- map1 + 
  geom_point(data=Coordinates_NPP, aes(x=Long, y=Lat),color= Coordinates_NPP$colors, size=1,stroke=0,shape=15)+
  ggtitle("Location GFBI Plots") +
  theme(plot.title = element_text(hjust = 0.5, size = 21, face = "bold"),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.ticks = element_blank())+
  ylim(-55,80) 
map

###Fig. 2B
set.seed(10)
Biome1 <- ProductivityFinal %>% filter(Biome==1) %>% sample_n(6656)
Biome2 <- ProductivityFinal %>% filter(Biome==2) %>% sample_n(522)
Biome3 <- ProductivityFinal %>% filter(Biome==3) %>% sample_n(214)
Biome4 <- ProductivityFinal %>% filter(Biome==4) %>% sample_n(226227)
Biome5 <- ProductivityFinal %>% filter(Biome==5) %>% sample_n(91801)
Biome6 <- ProductivityFinal %>% filter(Biome==6) %>% sample_n(56109)
Biome7 <- ProductivityFinal %>% filter(Biome==7) %>% sample_n(1405)
Biome8 <- ProductivityFinal %>% filter(Biome==8) %>% sample_n(31689)
Biome9 <- ProductivityFinal %>% filter(Biome==9) %>% sample_n(183)
Biome10 <- ProductivityFinal %>% filter(Biome==10) %>% sample_n(245)
Biome11 <- ProductivityFinal %>% filter(Biome==11) %>% sample_n(5297)
Biome12 <- ProductivityFinal %>% filter(Biome==12) %>% sample_n(22572)
Biome14 <- ProductivityFinal %>% filter(Biome==14) %>% sample_n(34)

SE_Boreal <- rbind(Biome6, Biome11 )
SE_Temperate <- rbind(Biome4, Biome5, Biome8, Biome12)
SE_Tropical <- rbind(Biome1, Biome2, Biome3, Biome7, Biome9, Biome14)

graph1 <- ggplot(data=SE_Boreal, aes(x= SE_Boreal$H1)) + geom_histogram(binwidth = 0.1, fill="darkgreen") +
  labs(title="Boreal biomes") + xlim(0,1) + scale_x_continuous(breaks=c(0,0.5,1)) +
  labs(x="Evenness", y="Number of plots") + theme_classic() +
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") 

graph2 <- ggplot(data=SE_Temperate, aes(x= SE_Temperate$H1)) + geom_histogram(binwidth = 0.1, fill="blue") +
  labs(title="Temperate biomes") + xlim(0,1) + scale_x_continuous(breaks=c(0,0.5,1)) +
  labs(x="Evenness", y="Number of plots") + theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") 

graph3 <- ggplot(data=SE_Tropical, aes(x= SE_Tropical$H1)) + geom_histogram(binwidth = 0.1, fill="orange") +
  labs(title="Tropical biomes") + xlim(0,1) + scale_x_continuous(breaks=c(0,0.5,1)) +
  labs(x="Evenness", y="Number of plots") + theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") 

graph4 <- ggplot(data=SE_Boreal, aes(x= SE_Boreal$S)) + geom_histogram(binwidth = 1, fill="darkgreen") +
  labs(title="Boreal biomes") + xlim(0,9) + scale_x_continuous(breaks=c(0,3,6,9)) +
  labs(x="Species richness", y="Number of plots") + theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") 

graph5 <- ggplot(data=SE_Temperate, aes(x= SE_Temperate$S)) + geom_histogram(binwidth = 1, fill="blue") +
  labs(title="Temperate biomes") + xlim(0,20) + scale_y_continuous(breaks=c(0,20000,40000,60000)) +
  labs(x="Species richness", y="Number of plots") + theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") 

graph6 <- ggplot(data=SE_Tropical, aes(x= SE_Tropical$S)) + geom_histogram(binwidth = 1, fill="orange") +
  labs(title="Tropical biomes") + xlim(0,100) + scale_y_continuous(breaks=c(0,200,400,600)) +
  labs(x="Species richness", y="Number of plots") + theme_classic()+
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 16),
        legend.position = "none") 

#Adding several graphs in one figure
margin = theme(plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"))

Fig2 <- grid.arrange(map,graph1,graph2,graph3,graph4,graph5,graph6,
             layout_matrix = matrix(c(1,1,1,
                                      1,1,1,
                                      2,3,4,
                                      5,6,7), 4, byrow = TRUE))
```
###Relationship evenness-richness Fig.3
```{r Relationship R-E}

ProductivityFinal <- fread("~/Documents/PhD projects/Biomass/NPP_24.11.2021.csv")

set.seed(10)
Biome1_Global <- ProductivityFinal %>% filter(Biome==1) %>% sample_n(6656)
Biome2_Global <- ProductivityFinal %>% filter(Biome==2) %>% sample_n(52)
Biome3_Global <- ProductivityFinal %>% filter(Biome==3) %>% sample_n(214)
Biome4_Global <- ProductivityFinal %>% filter(Biome==4) %>% sample_n(3039)
Biome5_Global <- ProductivityFinal %>% filter(Biome==5) %>% sample_n(1233)
Biome6_Global <- ProductivityFinal %>% filter(Biome==6) %>% sample_n(5072)
Biome7_Global <- ProductivityFinal %>% filter(Biome==7) %>% sample_n(1405)
Biome8_Global <- ProductivityFinal %>% filter(Biome==8) %>% sample_n(540)
Biome9_Global <- ProductivityFinal %>% filter(Biome==9) %>% sample_n(182)
Biome10_Global <- ProductivityFinal %>% filter(Biome==10) %>% sample_n(245)
Biome11_Global <- ProductivityFinal %>% filter(Biome==11) %>% sample_n(506)
Biome12_Global <- ProductivityFinal %>% filter(Biome==12) %>% sample_n(303)
Biome13_Global <- ProductivityFinal %>% filter(Biome==13) %>% sample_n(231)
Biome14_Global <- ProductivityFinal %>% filter(Biome==14) %>% sample_n(34)

SE_Global <- rbind(Biome1_Global, Biome2_Global, Biome3_Global, Biome4_Global, Biome5_Global, Biome6_Global, Biome7_Global, Biome8_Global, Biome9_Global, Biome10_Global, Biome11_Global, Biome12_Global,
                   Biome13_Global, Biome14_Global)
dim(SE_Global)
dim(SE_Boreal)
dim(SE_Temperate)
dim(SE_Tropical)

cor.test(log(SE_Global$S), SE_Global$H1, method = c("pearson")) #r=-0.53, df=19710, p<0.001
cor.test(log(SE_Boreal$S), SE_Boreal$H1, method = c("pearson")) #r=-0.41, df=61404, p<0.001
cor.test(log(SE_Temperate$S), SE_Temperate$H1, method = c("pearson")) #r=-0.53, df=372287, p<0.001
cor.test(log(SE_Tropical$S), SE_Tropical$H1, method = c("pearson")) #r=-0.48, df=9012, p<0.001

summary(lm(H1~log(S), data=SE_Global)) #r2=0.28
summary(lm(H1~log(S), data=SE_Boreal)) #r2=0.16
summary(lm(H1~log(S), data=SE_Temperate)) #r2=0.28
summary(lm(H1~log(S), data=SE_Tropical)) #r2=0.23

###Relationship evenness-richness without monospecific stands
ProductivityFinal_2sp <- ProductivityFinal[which(S>1),]

set.seed(10)
Biome1_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==1) %>% sample_n(6560)
Biome2_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==2) %>% sample_n(52)
Biome3_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==3) %>% sample_n(214)
Biome4_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==4) %>% sample_n(3039)
Biome5_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==5) %>% sample_n(1233)
Biome6_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==6) %>% sample_n(5072)
Biome7_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==7) %>% sample_n(1225)
Biome8_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==8) %>% sample_n(540)
Biome9_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==9) %>% sample_n(182)
Biome10_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==10) %>% sample_n(241)
Biome11_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==11) %>% sample_n(506)
Biome12_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==12) %>% sample_n(303)
Biome13_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==13) %>% sample_n(231)
Biome14_Global_2sp <- ProductivityFinal_2sp %>% filter(Biome==14) %>% sample_n(31)

SE_Global_2sp <- rbind(Biome1_Global_2sp, Biome2_Global_2sp, Biome3_Global_2sp, Biome4_Global_2sp, Biome5_Global_2sp, Biome6_Global_2sp, Biome7_Global_2sp, Biome8_Global_2sp, Biome9_Global_2sp, Biome10_Global_2sp, Biome11_Global_2sp, Biome12_Global_2sp,
                   Biome13_Global_2sp, Biome14_Global_2sp)

coef(lm(H1~log(S), data=SE_Global_2sp)) #log(S) -0.07
coef(lm(H1~log(S), data=SE_Global)) #log(S) -0.08

#Evaluate significance of the relationship
GlobalComplete <- SE_Global[,c("S", "H1")]
GlobalComplete$Type <- "Complete"
Global2sp <- SE_Global_2sp[,c("S", "H1")]
Global2sp$Type <- "Diverse"

DataRegression <- rbind(GlobalComplete, Global2sp)
summary(lm(H1~log(S)+log(S)*Type, data=DataRegression))

###Graphs Figure 3
paletteForUse <- c('#d10000', '#ff6622', '#ffda21', '#33dd00', '#1133cc', '#220066', '#330044')
colors <-  colorRampPalette(paletteForUse)(256)
SE_Global$dens <- col2rgb(densCols(SE_Global$H1, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]

GlobalSE <- ggplot(SE_Global, aes(log(S), H1)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("Evenness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Boreal$dens <- col2rgb(densCols(SE_Boreal$H1, SE_Boreal$log(S)))[1,] + 1L
SE_Boreal$colors = colors[SE_Boreal$dens]
BorealSE <- ggplot(SE_Boreal, aes(log(S), H1)) +
  geom_point(color= SE_Boreal$colors)+#stat_smooth(method="lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.42", x = 2, y = 1.1, size = 6, colour = "black") +
  #scale_y_continuous(breaks=c(0, 0.25,0.5, 0.75, 1)) +
  scale_x_continuous(breaks=c(0, 1, 2), labels=c("1","3","8"), limits=c(0,2)) +
  ylim(0,1)+theme_classic()+ ggtitle("Boreal ecoregions")+ylab("Evenness")+ xlab(" ") + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Temperate$dens <- col2rgb(densCols(SE_Temperate$H1, SE_Temperate$log(S)))[1,] + 1L
SE_Temperate$colors = colors[SE_Temperate$dens]
TemperateSE <- ggplot(SE_Temperate, aes(log(S), H1)) +
  geom_point(color= SE_Temperate$colors) + #stat_smooth(method="lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 2, y = 1.1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 1, 2, 3), labels=c("1","3","8","20"), limits=c(0,3)) +
  ylim(0,1)+theme_classic()+ggtitle("Temperate ecoregions")+
  ylab("Evenness")+ xlab(" ") + 
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Tropical$dens <- col2rgb(densCols(SE_Tropical$H1, SE_Tropical$log(S)))[1,] + 1L
SE_Tropical$colors = colors[SE_Tropical$dens]
TropicsSE <- ggplot(SE_Tropical, aes(log(S), H1)) +
  geom_point(color= SE_Tropical$colors)+#stat_smooth(method="lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.48", x = 0.6, y = 7.5, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1", "8", "55", "400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ ggtitle("Tropical ecoregions")+
  xlab("Species richness") + ylab("Evenness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

GlobalSE <- ggMarginal(GlobalSE, type="boxplot", size=20)
BorealSE <- ggMarginal(BorealSE, type="boxplot", size=20)
TemperateSE <- ggMarginal(TemperateSE, type="boxplot", size=20)
TropicsSE <- ggMarginal(TropicsSE, type="boxplot", size=20)

margin = theme(plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"))
Fig3 <- grid.arrange(GlobalSE,BorealSE, 
             TemperateSE, 
             TropicsSE,                               
             layout_matrix = matrix(c(1,1,2,
                                      1,1,3,
                                      1,1,4), 3, 3, byrow = TRUE))
```
###Models NPP and Biomass Fig.4
```{r setup, include=FALSE}
######NPP
###Tropical forest
Npp_Biome1 <- ProductivityFinal %>% filter(Biome==1)
Npp_Tropics <- Npp_Biome1[complete.cases(Npp_Biome1), ]

#Scale variables
Npp_Tropics_ToBeScaled <- Npp_Tropics[, c("Npp", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_regrowthForestAge_Mean_downsampled50km")]
Npp_Tropics_scaled <- as.data.frame(scale(Npp_Tropics_ToBeScaled)) #Scale data

#Model
Model_Tropics <- lm(Npp ~ log(S+1)*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature  + Isothermality +
                      Annual_Precipitation + Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm +
                      Human_Development_Percentage +log(Population_Density+1)+ GFAD_regrowthForestAge_Mean_downsampled50km,
                    data=Npp_Tropics_scaled)

#Model statistics
check_model(Model_Tropics)
vif(Model_Tropics)
summary(Model_Tropics) 
(coef <- as.data.frame(coefficients(Model_Tropics)))
calc.relimp(Model_Tropics, rela=TRUE)

###Temperate forest
Npp_Biome4 <- ProductivityFinal %>% filter(Biome==4)
Npp_Temperate <- Npp_Biome4[complete.cases(Npp_Biome4), ]

#Scale variables
Npp_Temperate_ToBeScaled <- Npp_Temperate[, c("Npp", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_regrowthForestAge_Mean_downsampled50km")]
Npp_Temperate_Scaled <- as.data.frame(scale(Npp_Temperate_ToBeScaled)) #Scale data

#check outliers
#ggplot(stack(dataset), aes(x = ind, y = values)) + geom_boxplot()
#boxplot(dataset$S*dataset$H1)

#Model
Model_Temperate <- lm(Npp ~ S*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1) +
                        GFAD_regrowthForestAge_Mean_downsampled50km, data=Npp_Temperate_Scaled) 

#Model statistics
check_model(Model_Temperate)
vif(Model_Temperate)
summary(Model_Temperate) 
(coef <- as.data.frame(coefficients(Model_Temperate)))
calc.relimp(Model_Temperate, rela=TRUE)

###Boreal forest
Npp_Biome6 <- ProductivityFinal %>% filter(Biome==6)
Npp_Boreal <- Npp_Biome6[complete.cases(Npp_Biome6), ]

#Scale variables
Npp_Boreal_ToBeScaled <- Npp_Boreal[, c("Npp", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_regrowthForestAge_Mean_downsampled50km")]
Npp_Boreal_Scaled <- as.data.frame(scale(Npp_Boreal_ToBeScaled)) #Scale data

#check outliers
#ggplot(stack(dataset), aes(x = ind, y = values)) + geom_boxplot()
#boxplot(dataset$S*dataset$H1)

#Model
Model_Boreal <- lm(Npp ~ S*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1) +
                        GFAD_regrowthForestAge_Mean_downsampled50km, data=Npp_Boreal_Scaled) 

#Model statistics
check_model(Model_Boreal)
vif(Model_Boreal)
summary(Model_Boreal) 
(coef <- as.data.frame(coefficients(Model_Boreal)))
calc.relimp(Model_Boreal, rela=TRUE)

###Global forest
Global_Npp <- SE_Global
Global_Npp <- Global_Npp[complete.cases(Global_Npp), ]

#Scale variables
Global_Npp_ToBeScaled <- Global_Npp[, c("Npp", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_regrowthForestAge_Mean_downsampled50km")]
Global_Npp_ToBeScaled <- as.data.frame(scale(Global_Npp_ToBeScaled))
Global_Npp_ToBeScaled <- cbind(Global_Npp_ToBeScaled, Global_Npp$Biome) #Add WWF Biome to global model
setnames(Global_Npp_ToBeScaled, old = c("Global_Npp$Biome"), new = c("Biome"))
Global_Npp_scaled <- as.data.frame(Global_Npp_ToBeScaled)

#check outliers
#ggplot(stack(dataset), aes(x = ind, y = values)) + geom_boxplot()
#boxplot(dataset$S*dataset$H1)

#Model
Model_Global <- lm(Npp ~ log(S+1)*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature  + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1)+
                             GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_scaled)

#Model statistics
check_model(Model_Global)
vif(Model_Global)
summary(Model_Global)
(coef <- as.data.frame(coefficients(Model_Global)))
calc.relimp(Model_Global, rela=TRUE)


######Biomass
###Tropical forest
Biomass_Biome1 <- Biomass %>% filter(WWFBiome==1)
Biomass_Tropics <- Biomass_Biome1[complete.cases(Biomass_Biome1), ]

#Scale variables
Biomass_Tropics_ToBeScaled <- Biomass_Tropics[, c("BiomassYr", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "ForestAge")]
Biomass_Tropics_scaled <- as.data.frame(scale(Biomass_Tropics_ToBeScaled)) #Scale data

#Model
Model_Tropics <- lm(BiomassYr ~ log(S+1)*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature  + Isothermality + Annual_Precipitation +
                            Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1)+
                    ForestAge, data=Biomass_Tropics_scaled)

#Model statistics
check_model(Model_Tropics)
vif(Model_Tropics)
summary(Model_Tropics) 
(coef <- as.data.frame(coefficients(Model_Tropics)))
calc.relimp(Model_Tropics, rela=TRUE)

###Temperate forest
Biomass_Biome4 <- Biomass %>% filter(WWFBiome==4)
Biomass_Temperate <- Biomass_Biome4[complete.cases(Biomass_Biome4), ]

#Scale variables
Biomass_Temperate_ToBeScaled <- Biomass_Temperate[, c("BiomassYr", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "ForestAge")]
Biomass_Temperate_scaled <- as.data.frame(scale(Biomass_Temperate_ToBeScaled)) #Scale data

#Model
Model_Temperate <- lm(BiomassYr ~ log(S+1)*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature  + Isothermality + Annual_Precipitation +
                            Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1)+
                    ForestAge, data=Biomass_Temperate_scaled)

#Model statistics
check_model(Model_Temperate)
vif(Model_Temperate)
summary(Model_Temperate) 
(coef <- as.data.frame(coefficients(Model_Temperate)))
calc.relimp(Model_Temperate, rela=TRUE)


###Boreal forest
Biomass_Biome6 <- Biomass %>% filter(WWFBiome==6)
Biomass_Boreal <- Biomass_Biome6[complete.cases(Biomass_Biome6), ]

#Scale variables
Biomass_Boreal_ToBeScaled <- Biomass_Boreal[, c("BiomassYr", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "ForestAge")]
Biomass_Boreal_scaled <- as.data.frame(scale(Biomass_Boreal_ToBeScaled)) #Scale data

#Model
Model_Boreal <- lm(BiomassYr ~ log(S+1)*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature  + Isothermality + Annual_Precipitation +
                            Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1)+
                    ForestAge, data=Biomass_Boreal_scaled)

#Model statistics
check_model(Model_Boreal)
vif(Model_Boreal)
summary(Model_Boreal) 
(coef <- as.data.frame(coefficients(Model_Boreal)))
calc.relimp(Model_Boreal, rela=TRUE)


###Global forest
Biomass_Global <- Biomass_Global[complete.cases(Biomass_Global), ]

#Scale variables
Biomass_Global_ToBeScaled <- Biomass_Global[, c("BiomassYr", "S", "H1", "Plotsize", "TreesPerHa", "Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "ForestAge", "WWFBiome")]
Biomass_Global_scaled <- as.data.frame(scale(Biomass_Global_ToBeScaled)) #Scale data

#Model
Model_Global <- lm(BiomassYr ~ log(S+1)*H1 + log(TreesPerHa+1) + Plotsize + Annual_Mean_Temperature  + Isothermality + Annual_Precipitation +
                            Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + log(Population_Density+1)+
                    ForestAge + factor(WWFBiome), data=Biomass_Global_scaled)

#Model statistics
check_model(Model_Global)
vif(Model_Global)
summary(Model_Global) 
(coef <- as.data.frame(coefficients(Model_Global)))
calc.relimp(Model_Global, rela=TRUE)

#The coefficients and variable importance were extracted from the model above and put together in the VariableImportance01.2020.csv file

######Graph coefficients
Beta_coef <- fread("~/Documents/PhD projects/Biomass/VariableImportance01.2022.csv")

Beta_coef <- subset(Beta_coef, Version=="New")
Beta_coef_Biomass <- subset(Beta_coef, Subject == "B")
Beta_coef_NPP <- subset(Beta_coef, Subject == "P")

Beta_coef_Biomass$BiomeName <- factor(Beta_coef_Biomass$BiomeName, levels = c("Boreal forest", "Temperate forest", "Tropical moist forest", "Global"))
Beta_coef_Biomass$Variable <- factor(Beta_coef_Biomass$Variable, levels = c("S", "H1", "S:H1", "TreesPerHa", "ForestAge", "Annual_Mean_Temperature", "Isothermality", "Annual_Precipitation", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "CContent_15cm", "Human_Development_Percentage", "Population_Density"))
Beta_coef_Biomass <- Beta_coef_Biomass[!is.na(Beta_coef_Biomass$Variable),]

heatmap<-ggplot(data=Beta_coef_Biomass, aes(x=BiomeName, y=Variable, fill=Coefficient))+ #Define NA
  geom_point(aes(size = Coefficient, color = Sign, shape=factor(Significant)))+ 
  scale_color_manual(values=c("#2832eb", "#76bd60"))+
  scale_size_area(max_size = 20) +
  scale_shape_manual(values=c(1, 16)) +
  theme_void()+
  ylab("")+xlab("")+ ggtitle("Biomass")+
  theme(legend.position = "none",
        plot.title = element_text(color="black", size=23, face="bold", hjust = 0.5),
        axis.text.x = element_text(family="sans", size=20, angle=10, color="#4d4d4d"),
        axis.text.y=element_text(family="sans", size=20),
        axis.line = element_blank(),
        axis.ticks = element_blank()) +
  scale_y_discrete(labels=c("Species richness", "Evenness", "Interaction", "Trees/ha", "Forest age", "Temperature", "Isothermality", "Precipitation", "Seasonal Precipitation", "Sand content soil", "Soil pH", "Soil carbon", "Human development", "Population density"))+
  scale_x_discrete(position="bottom",labels=c("Boreal", "Temperate", "Tropical", "Global")) 

Beta_coef_NPP$BiomeName <- factor(Beta_coef_NPP$BiomeName, levels = c("Boreal forest", "Temperate forest", "Tropical moist forest", "Global"))
Beta_coef_NPP$Variable <- factor(Beta_coef_NPP$Variable, levels = c("S", "H1", "S:H1", "TreesPerHa", "ForestAge", "Annual_Mean_Temperature", "Isothermality", "Annual_Precipitation", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "CContent_15cm", "Human_Development_Percentage", "Population_Density"))
Beta_coef_NPP <- Beta_coef_NPP[!is.na(Beta_coef_NPP$Variable),]

heatmapNpp <-ggplot(data=Beta_coef_NPP, aes(x=BiomeName, y=Variable, fill=Coefficient))+ #Define NA
  geom_point(aes(size = Coefficient, color = Sign, shape=factor(Significant)))+ 
  scale_color_manual(values=c("#2832eb", "#76bd60"))+
  scale_size_area(max_size = 20) +
  scale_shape_manual(values=c(1, 16)) +
  theme_void()+
  ylab("")+xlab("")+
  ggtitle("Productivity")+
  theme(legend.position = "none",
        plot.title = element_text(color="black", size=23, face="bold", hjust = 0.5),
        axis.text.x = element_text(family="sans", size=20, angle=10, color="#4d4d4d"),
        axis.text.y= element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank()) +
  scale_y_discrete(labels=c("Species richness", "Evenness", "Interaction",  "Trees/ha", "Forest age","Temperature", "Isothermality", "Precipitation", "Seasonal Precipitation", "Sand content soil", "Soil pH", "Soil carbon", "Human development", "Population density")) +
  scale_x_discrete(position="bottom",labels=c("Boreal", "Temperate", "Tropical", "Global")) 

grid.arrange(heatmap, heatmapNpp, layout_matrix = matrix(c(1,1,1, 2,2), 1, 5, byrow = TRUE))

######Graph variable importance
data <- fread("~/Documents/PhD projects/Biomass/VariableImportance01.2022.csv")

data <- subset(data, Version=="New")
Biomass <- subset(data, Subject == "B")
Npp <- subset(data, Subject == "P")

Biomass$BiomeName <- factor(Biomass$BiomeName, levels = c("Boreal forest", "Temperate forest", "Tropical moist forest", "Global"))
Biomass$Topic <- factor(Biomass$Topic, levels = c("Richness", "Evenness", "Interaction", "Climate", "Soil characteristics", "Trees/ha", "Human impact"))

Npp$BiomeName <- factor(Npp$BiomeName, levels = c("Boreal forest", "Temperate forest", "Tropical moist forest", "Global"))
Npp$Topic <- factor(Npp$Topic, levels = c("Richness", "Evenness", "Interaction", "Climate", "Soil characteristics", "Trees/ha", "Human impact"))

#Rotated Bargraph
g <- ggplot(data = Biomass, aes(y = Biomass$VarImportance, x = Biomass$BiomeName, fill = forcats::fct_rev(factor(Biomass$Topic)))) + 
  geom_bar(stat="identity", position = "stack") + 
  scale_fill_manual(values=c ("#3d7a3e", "#647fed", "#2832eb", "#76bd60", "#ecf01f", "#eba134", "#f2290f")) +
  theme_classic()+ labs(fill = "Legend") +
  ggtitle("Biomass")+
  ylab("Variable importance (%)")+
  scale_x_discrete(position="bottom",labels=c("Boreal", "Temperate", "Tropical", "Global")) +
  theme(plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        legend.position = "none",
        axis.title.x =element_blank(),
        axis.text.x = element_text(size = 20, angle=10),
        axis.title.y = element_text(size = 20),
        axis.text.y = element_text(size = 30)) #+  coord_flip() 

h <- ggplot(data = Npp, aes(y = Npp$VarImportance, x = Npp$BiomeName, fill = forcats::fct_rev(factor(Npp$Topic)))) + 
  geom_bar(stat="identity", position = "stack") + 
  scale_fill_manual(values=c ("#3d7a3e", "#647fed", "#2832eb", "#76bd60", "#ecf01f", "#eba134", "#f2290f")) +
  theme_classic()+ labs(fill = "Legend") +
  ggtitle("Productivity")+
  ylab("Variable importance (%)")+
  scale_x_discrete(position="bottom",labels=c("Boreal", "Temperate", "Tropical", "Global")) +
  theme(plot.title = element_text(hjust = 0.5, size = 25, face = "bold"),
        legend.position = "right",
        legend.title = element_text(size=18),
        legend.text=element_text(size=16),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 20, angle=10),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) #+  coord_flip() 

grid.arrange(g,h, layout_matrix = matrix(c(1,1,1,1,1,1,2,2,2,2,2,2,2), 1,13, byrow = TRUE))

```
###Interaction graph NPP Fig.5
```{r Interaction NPP}

###############################################################################Tropical forest
Npp_Biome1 <- ProductivityFinal %>% filter(Biome==1)
Npp_Tropics <- Npp_Biome1[complete.cases(Npp_Biome1), ]

#Projections
DepVar <- Npp_Tropics[, c("S", "Biome", "Diversity", "H1", "Npp", "Plotsize", "Plot_ID")]
IndVar <- Npp_Tropics[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Npp_Tropics$Plot_ID)
setnames(scaled, old = c("Npp_Tropics$Plot_ID"), new = c("Plot_ID"))
Npp_Tropics_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Tropics_Npp_Projection <- lm(Npp ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km,data=Npp_Tropics_Scaled)  

Model_ES <- gam(H1~S, data=Npp_Tropics_Scaled)
Data_ES <- with(Npp_Tropics_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Npp_Tropics_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T)))

H1_cut <- quantile(Npp_Tropics_Scaled$H1, c(0.043, .24, .63, 1), na.rm=T) #Tropical
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_datTrop <- all_dat %>% mutate(Npp = predict(Tropics_Npp_Projection, newdata = all_dat))

#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(prod_pred = predict(Tropics_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Npp_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(prod_pred = predict(Tropics_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Npp_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(prod_pred = predict(Tropics_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Npp_H1_lower"="prod_pred"))  

Data_ES_Tropical <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Tropics, file="Data_ES_Global2021.csv")
#fwrite(all_datTrop, file="GraphTropicsNPP2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphTropicsNPP.csv")
#Data_ES_Tropics <- fread("~/Documents/PhD projects/Biomass/Data_ES_Tropics.csv")

#Graphs
maxNPP <- Npp_Tropics %>% summarise(quants = quantile(Npp), probs = c(0.25)) 
maxNPP <- as.data.frame(maxNPP)

TropicalGraphRichness <- ggplot(all_datTrop, aes(x=S, y=Npp, color=factor(H1)))+
  geom_point()+ ggtitle('Tropical moist forest')+ theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"))+
  guides(colour = guide_legend(reverse=T)) +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12000, 15000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Tropical, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Tropical, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Tropical, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

#Variable importance richness, evenness and interaction
data <- fread("~/Documents/PhD projects/Biomass/VariableImportance01.2022.csv")
data <- subset(data, Version=="New")
data$BiomeName <- factor(data$BiomeName, levels = c("Boreal forest", "Temperate forest", "Tropical moist forest", "Global"))
data$Topic <- factor(data$Topic, levels = c("Richness", "Evenness", "Interaction", "Climate", "Soil characteristics", "Trees/ha", "Human impact"))
Npp <- subset(data, Subject == "P")
NppREI <- subset(Npp, Topic == "Richness"|Topic == "Evenness"|Topic == "Interaction")
NppREITropical <- subset(NppREI, BiomeName == "Tropical moist forest")

TropicalREI <-  ggplot(data = NppREITropical, aes(y = NppREITropical$VarImportance, x = NppREITropical$BiomeName, 
                                                    fill = reorder(factor(NppREITropical$Topic), desc(factor(NppREITropical$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

TropicalNpp <- grid.arrange(TropicalGraphRichness, TropicalREI,                           
                             layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###############################################################################Temperate forest
Npp_Biome4 <- ProductivityFinal %>% filter(Biome==4)
Npp_Temperate <- Npp_Biome4[complete.cases(Npp_Biome4), ]

#Projections
DepVar <- Npp_Temperate[, c("S", "Biome", "Diversity", "H1", "Npp", "Plotsize", "Plot_ID")]
IndVar <- Npp_Temperate[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Npp_Temperate$Plot_ID)
setnames(scaled, old = c("Npp_Temperate$Plot_ID"), new = c("Plot_ID"))
Npp_Temperate_scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Temperate_Npp_Projection <- lm(Npp ~ S*H1 + S + H1 + TreesPerHa + Annual_Mean_Temperature + Plotsize + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km,data=Npp_Temperate_scaled)  

Model_ES <- gam(H1~S, data=Npp_Temperate_scaled)
Data_ES <- with(Npp_Temperate_scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Npp_Temperate_scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T)))

H1_cut <- quantile(Npp_Temperate_scaled$H1, c(0.012, .13, .55, 1), na.rm=T) #Temperate
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_datTemp <- all_dat %>% mutate(Npp = predict(Temperate_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(prod_pred = predict(Temperate_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Npp_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(prod_pred = predict(Temperate_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Npp_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(prod_pred = predict(Temperate_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Npp_H1_lower"="prod_pred"))  
#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal

Data_ES_Temperate <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Temperate, file="Data_ES_Global2021.csv")
#fwrite(all_datTemp, file="GraphTemperateNPP2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphTemperateNPP.csv")
#Data_ES_Temperate <- fread("~/Documents/PhD projects/Biomass/Data_ES_Temperate.csv")

#Graphs
maxNPP <- Npp_Temperate %>% summarise(quants = quantile(Npp), probs = c(0.25)) 
maxNPP <- as.data.frame(maxNPP)

TemperateGraphRichness <- ggplot(all_datTemp, aes(x=S, y=Npp, color=factor(H1)))+
  geom_point()+ 
  ggtitle('Temperate forest')+
  theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"))+
  guides(colour = guide_legend(reverse=T)) +
  xlab(" ") + ylab("NPP in kg*C/m^2 yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(5500, 7300)) + xlim(c(0,30)) +
  #geom_smooth(data=NPP_TemperateMeanSubset, mapping=aes(x=S, y=MeanNPP), color="black", se = FALSE, linetype = "dashed")+
  #geom_smooth(data = Data_ESTemp, aes(x =S, y = prod_pred), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=TRUE)+
  geom_smooth(data = Data_ES_Temperate, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Temperate, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Temperate, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###Variable importance richness, evenness and interaction
NppREITemperate <- subset(NppREI, BiomeName == "Temperate forest")

TemperateREI <-  ggplot(data = NppREITemperate, aes(y = NppREITemperate$VarImportance, x = NppREITemperate$BiomeName, 
                                               fill = reorder(factor(NppREITemperate$Topic), desc(factor(NppREITemperate$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

TemperateNpp <- grid.arrange(TemperateGraphRichness, TemperateREI,                           
                      layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###############################################################################Boreal forest
Npp_Biome6 <- ProductivityFinal %>% filter(Biome==6)
Npp_Boreal <- Npp_Biome6[complete.cases(Npp_Biome6), ]

#Projections
DepVar <- Npp_Boreal[, c("S", "Biome", "H1", "Npp", "Plotsize", "Plot_ID")]
IndVar <- Npp_Boreal[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Npp_Boreal$Plot_ID)
setnames(scaled, old = c("Npp_Boreal$Plot_ID"), new = c("Plot_ID"))
Npp_Boreal_scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Boreal_Npp_Projection <- lm(Npp ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km,data=Npp_Boreal_scaled)  

Model_ES <- gam(H1~S, data=Npp_Boreal_scaled)
Data_ES <- with(Npp_Boreal_scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Npp_Boreal_scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T)))

H1_cut <- quantile(Npp_Boreal_scaled$H1, c(0.005, .06, .4, 1), na.rm=T) #Boreal 
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_datBoreal <- all_dat %>% mutate(Npp = predict(Boreal_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(prod_pred = predict(Boreal_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Npp_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(prod_pred = predict(Boreal_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Npp_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(prod_pred = predict(Boreal_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Npp_H1_lower"="prod_pred"))  
#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal

Data_ES_Boreal <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Boreal, file="Data_ES_Global2021.csv")
#fwrite(all_datTemp, file="GraphBorealNPP2021.csv")

#all_datBoreal <- fread("~/Documents/PhD projects/Biomass/GraphBorealNPP.csv")
#Data_ES_Boreal <- fread("~/Documents/PhD projects/Biomass/Data_ES_Boreal.csv")

#Graphs
maxNPP <- Npp_Boreal %>% summarise(quants = quantile(Npp), probs = c(0.25)) 
maxNPP <- as.data.frame(maxNPP)

BorealGraphRichness <- ggplot(all_datBoreal, aes(x=S, y=Npp, color=factor(H1)))+
  geom_point()+ ggtitle('Boreal forest')+theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"))+
  guides(colour = guide_legend(reverse=T)) +
  xlab(" ") + ylab("NPP in kg*C/m^2 yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(5400, 6200)) +
  geom_smooth(data = Data_ES_Boreal, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Boreal, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Boreal, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

NppREIBoreal <- subset(NppREI, BiomeName == "Boreal forest")

BorealREI <-  ggplot(data = NppREIBoreal, aes(y = NppREIBoreal$VarImportance, x = NppREIBoreal$BiomeName, 
                                                  fill = reorder(factor(NppREIBoreal$Topic), desc(factor(NppREIBoreal$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

BorealNpp <- grid.arrange(BorealGraphRichness, BorealREI,                           
                            layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###############################################################################Global forest
Global_Npp <- SE_Global
Global_Npp <- Global_Npp[complete.cases(Global_Npp), ]

#Projections
DepVar <- Global_Npp[, c("S", "Biome", "Diversity", "H1", "Npp", "Plotsize", "Plot_ID")]
IndVar <- Global_Npp[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Global_Npp$Plot_ID)
setnames(scaled, old = c("Global_Npp$Plot_ID"), new = c("Plot_ID"))
Global_Npp_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(H1~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T),  Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = median(Biome)))

H1_cut <- quantile(Global_Npp_Scaled$H1, c(0.023, .138, .5, 1), na.rm=T) #Global
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_dat$Biome <- "7"
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = 7) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Npp_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(Biome = 7) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Npp_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(Biome = 7) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Npp_H1_lower"="prod_pred"))  
#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
maxNPP <- Global_Npp %>% summarise(quants = quantile(Npp), probs = c(0.25)) 
maxNPP <- as.data.frame(maxNPP)

NppREIGlobal <- subset(NppREI, BiomeName == "Global")

GlobalGraphRichness <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(H1))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.6", "0.6-0.8", "0.8-1"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(7000, 11000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_lower), color = "grey", size=1, method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_upper), color = "grey", size=1, method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_mean), color = "black", size=1, method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

GlobalREI <-  ggplot(data = NppREIGlobal, aes(y = NppREIGlobal$VarImportance, x = NppREIGlobal$BiomeName, 
                                              fill = reorder(factor(NppREIGlobal$Topic), desc(factor(NppREIGlobal$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + 
  geom_label(aes(x = 1, y = NppREIGlobal$VarImportance/23, label = factor(NppREIGlobal$Topic), fontface = "bold"),
             position = position_stack(vjust = .5), size = 5, colour = "white", show.legend = FALSE) +
  scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

GlobalNpp <- grid.arrange(GlobalGraphRichness, GlobalREI,                           
                          layout_matrix = matrix(c(1,1,1,1,2), 1, 5, byrow = TRUE))

###Adding several graphs in one figure
margin = theme(plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"))
Fig4B <- grid.arrange(GlobalNpp,BorealNpp, 
             TemperateNpp, 
             TropicalNpp,                               
             layout_matrix = matrix(c(1,1,2,
                                      1,1,3,
                                      1,1,4), 3, 3, byrow = TRUE))
```
###Interaction graph Biomass Fig.5
```{r Biomass interaction, include=FALSE}
Biomass <- fread("~/Documents/PhD projects/Biomass/Biomass20.08.2020.csv")
Biomass$TreesPerHa <- round(Biomass$treeNumber/Biomass$plotArea, 0)

# cor.test(Biomass$biomassDensity, Biomass$Npp, method=c("spearman"))

#Global datasample 
Biomass_Biome1_Global <- Biomass %>% filter(WWFBiome==1) %>% sample_n(3076)
Biomass_Biome2_Global <- Biomass %>% filter(WWFBiome==2) %>% sample_n(100)
Biomass_Biome4_Global <- Biomass %>% filter(WWFBiome==4) %>% sample_n(1348)
Biomass_Biome5_Global <- Biomass %>% filter(WWFBiome==5) %>% sample_n(547)
Biomass_Biome6_Global <- Biomass %>% filter(WWFBiome==6) %>% sample_n(2250)
Biomass_Biome7_Global <- Biomass %>% filter(WWFBiome==7) %>% sample_n(641)
Biomass_Biome8_Global <- Biomass %>% filter(WWFBiome==8) %>% sample_n(200)
Biomass_Biome9_Global <- Biomass %>% filter(WWFBiome==9) %>% sample_n(1)
Biomass_Biome10_Global <- Biomass %>% filter(WWFBiome==10) %>% sample_n(109)
Biomass_Biome11_Global <- Biomass %>% filter(WWFBiome==11) %>% sample_n(225)
Biomass_Biome12_Global <- Biomass %>% filter(WWFBiome==12) %>% sample_n(134)
Biomass_Biome13_Global <- Biomass %>% filter(WWFBiome==13) %>% sample_n(102)

Biomass_Global <- rbind(Biomass_Biome1_Global, Biomass_Biome2_Global, Biomass_Biome4_Global, Biomass_Biome5_Global, Biomass_Biome6_Global, Biomass_Biome7_Global, Biomass_Biome8_Global, Biomass_Biome9_Global, Biomass_Biome10_Global, Biomass_Biome11_Global, Biomass_Biome12_Global, Biomass_Biome13_Global)

###############################################################################Tropical forest
Biomass_Biome1 <- Biomass %>% filter(WWFBiome==1)
Biomass_Tropics <- Biomass_Biome1[complete.cases(Biomass_Biome1), ]

#Projections
DepVar <- Biomass_Tropics[, c("S", "WWFBiome", "Diversity", "H1", "BiomassYr", "Plotsize", "Plot_ID")]
IndVar <- Biomass_Tropics[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "ForestAge", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Biomass_Tropics$Plot_ID)
setnames(scaled, old = c("Biomass_Tropics$Plot_ID"), new = c("Plot_ID"))
Biomass_Tropics_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Tropics_Biomass_Projection <- lm(BiomassYr ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 ForestAge,data=Biomass_Tropics_Scaled)  

Model_ES <- gam(H1~S, data=Biomass_Tropics_Scaled)
Data_ES <- with(Biomass_Tropics_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Biomass_Tropics_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), ForestAge = median(ForestAge, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T)))

H1_cut <- quantile(Biomass_Tropics_Scaled$H1, c(0.04, .2, .58, 1), na.rm=T) #Tropical
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_datTrop <- all_dat %>% mutate(BiomassYr = predict(Tropics_Biomass_Projection, newdata = all_dat))

#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(prod_pred = predict(Tropics_Biomass_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Biomass_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(prod_pred = predict(Tropics_Biomass_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Biomass_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(prod_pred = predict(Tropics_Biomass_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Biomass_H1_lower"="prod_pred"))  

Data_ES_Tropical <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Tropics, file="Data_ES_Global2021.csv")
#fwrite(all_datTrop, file="GraphTropicsBiomass2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphTropicsBiomass.csv")
#Data_ES_Tropics <- fread("~/Documents/PhD projects/Biomass/Data_ES_Tropics.csv")

#Graphs
maxBiomass <- Biomass_Tropics %>% summarise(quants = quantile(BiomassYr), probs = c(0.25)) 
maxBiomass <- as.data.frame(maxBiomass)

TropicalGraphBiomass <- ggplot(all_datTrop, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+ 
  ggtitle('Tropical moist forest')+
  theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a")) +
  xlab("Species richness") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(5000, 16000)) + xlim(c(0,170)) +
  geom_smooth(data = Data_ES_Tropical, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Tropical, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Tropical, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold"))

#Variable importance richness, evenness and interaction
data <- fread("~/Documents/PhD projects/Biomass/VariableImportance01.2022.csv")
data <- subset(data, Version=="New")
data$BiomeName <- factor(data$BiomeName, levels = c("Boreal forest", "Temperate forest", "Tropical moist forest", "Global"))
data$Topic <- factor(data$Topic, levels = c("Richness", "Evenness", "Interaction", "Climate", "Soil characteristics", "Trees/ha", "Human impact"))
BiomassB <- subset(data, Subject == "B")
BiomasREI <- subset(BiomassB, Topic == "Richness"|Topic == "Evenness"|Topic == "Interaction")
BiomasREITropical <- subset(BiomassREI, BiomeName == "Tropical moist forest")

TropicalREI <-  ggplot(data = BiomassREITropical, aes(y = BiomassREITropical$VarImportance, x = BiomassREITropical$BiomeName, 
                                                    fill = reorder(factor(BiomassREITropical$Topic), desc(factor(BiomassREITropical$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

TropicalBiomass <- grid.arrange(TropicalGraphBiomass, TropicalREI,                           
                             layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###############################################################################Temperate forest
Biomass_Biome4 <- Biomass %>% filter(WWFBiome==4)
Biomass_Temperate <- Biomass_Biome4[complete.cases(Biomass_Biome4), ]

#Projections
DepVar <- Biomass_Temperate[, c("S", "WWFBiome", "Diversity", "H1", "BiomassYr", "Plotsize", "Plot_ID")]
IndVar <- Biomass_Temperate[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "ForestAge", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Biomass_Temperate$Plot_ID)
setnames(scaled, old = c("Biomass_Temperate$Plot_ID"), new = c("Plot_ID"))
Biomass_Temperate_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Temperate_Biomass_Projection <- lm(BiomassYr ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 ForestAge,data=Biomass_Temperate_Scaled)  

Model_ES <- gam(H1~S, data=Biomass_Temperate_Scaled)
Data_ES <- with(Biomass_Temperate_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Biomass_Temperate_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T),Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), ForestAge = median(ForestAge, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T)))

H1_cut <- quantile(Biomass_Temperate_Scaled$H1, c(0.04, .2, .58, 1), na.rm=T) #Temperate
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_datTemperate <- all_dat %>% mutate(BiomassYr = predict(Temperate_Biomass_Projection, newdata = all_dat))

#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(prod_pred = predict(Temperate_Biomass_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Biomass_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(prod_pred = predict(Temperate_Biomass_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Biomass_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(prod_pred = predict(Temperate_Biomass_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Biomass_H1_lower"="prod_pred"))  

Data_ES_Temperate <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Temperate, file="Data_ES_Global2021.csv")
#fwrite(all_datTrop, file="GraphTemperateBiomass2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphTemperateBiomass.csv")
#Data_ES_Temperate <- fread("~/Documents/PhD projects/Biomass/Data_ES_Temperate.csv")

#Graphs
maxBiomass <- Biomass_Temperate %>% summarise(quants = quantile(BiomassYr), probs = c(0.25)) 
maxBiomass <- as.data.frame(maxBiomass)

TemperateGraphBiomass <- ggplot(all_datTemperate, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+ 
  ggtitle('Temperate forest')+
  theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"))+
  xlab(" ") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(2200, 5000)) + xlim(c(0,30)) +
  geom_smooth(data = Data_ES_Temperate, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Temperate, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Temperate, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position= "none", 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

#Variable importance richness, evenness and interaction
BiomassREITemperate <- subset(BiomassREI, BiomeName == "Temperate forest")

TemperateREI <-  ggplot(data = BiomassREITemperate, aes(y = BiomassREITemperate$VarImportance, x = BiomassREITemperate$BiomeName, 
                                                    fill = reorder(factor(BiomassREITemperate$Topic), desc(factor(BiomassREITemperate$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

TemperateBiomass <- grid.arrange(TemperateGraphBiomass, TemperateREI,                           
                             layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###############################################################################Boreal forest
Biomass_Biome6 <- Biomass %>% filter(WWFBiome==6)
Biomass_Boreal <- Biomass_Biome6[complete.cases(Biomass_Biome6), ]

#Projections
DepVar <- Biomass_Boreal[, c("S", "WWFBiome", "Diversity", "H1", "BiomassYr", "Plotsize", "Plot_ID")]
IndVar <- Biomass_Boreal[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "ForestAge", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Biomass_Boreal$Plot_ID)
setnames(scaled, old = c("Biomass_Boreal$Plot_ID"), new = c("Plot_ID"))
Biomass_Boreal_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Boreal_Biomass_Projection <- lm(BiomassYr ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 ForestAge,data=Biomass_Boreal_Scaled)  

Model_ES <- gam(H1~S, data=Biomass_Boreal_Scaled)
Data_ES <- with(Biomass_Boreal_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Biomass_Boreal_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T),  Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), ForestAge = median(ForestAge, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T)))

H1_cut <- quantile(Biomass_Boreal_Scaled$H1, c(0.04, .2, .58, 1), na.rm=T) #Boreal
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_datBoreal <- all_dat %>% mutate(BiomassYr = predict(Boreal_Biomass_Projection, newdata = all_dat))

#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(prod_pred = predict(Boreal_Biomass_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Biomass_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(prod_pred = predict(Boreal_Biomass_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Biomass_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(prod_pred = predict(Boreal_Biomass_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Biomass_H1_lower"="prod_pred"))  

Data_ES_Boreal <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Boreal, file="Data_ES_Global2021.csv")
#fwrite(all_datTrop, file="GraphBorealBiomass2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphBorealBiomass.csv")
#Data_ES_Boreal <- fread("~/Documents/PhD projects/Biomass/Data_ES_Boreal.csv")

#Graphs
maxBiomass <- Biomass_Boreal %>% summarise(quants = quantile(BiomassYr), probs = c(0.25)) 
maxBiomass <- as.data.frame(maxBiomass)

BorealGraphBiomass <- ggplot(all_datBoreal, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+ 
  ggtitle('Boreal forest')+
  theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a")) +
  xlab(" ") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(400, 1400)) + 
  geom_smooth(data = Data_ES_Boreal, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Boreal, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Boreal, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none", 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

#Variable importance richness, evenness and interaction

BiomassREIBoreal <- subset(BiomassREI, BiomeName == "Boreal forest")

BorealREI <-  ggplot(data = BiomassREIBoreal, aes(y = BiomassREIBoreal$VarImportance, x = BiomassREIBoreal$BiomeName, 
                                                    fill = reorder(factor(BiomassREIBoreal$Topic), desc(factor(BiomassREIBoreal$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

BorealBiomass <- grid.arrange(BorealGraphBiomass, BorealREI,                           
                             layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###############################################################################Global forest
Biomass_Global <- Biomass_Global[complete.cases(Biomass_Global), ]

#Projections
DepVar <- Biomass_Global[, c("S", "WWFBiome", "Diversity", "H1", "BiomassYr", "Plotsize", "Plot_ID")]
IndVar <- Biomass_Global[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "ForestAge", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Biomass_Global$Plot_ID)
setnames(scaled, old = c("Biomass_Global$Plot_ID"), new = c("Plot_ID"))
Biomass_Global_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Global_Biomass_Projection <- lm(BiomassYr ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 ForestAge + factor(WWFBiome),data=Biomass_Global_Scaled)  

Model_ES <- gam(H1~S, data=Biomass_Global_Scaled)
Data_ES <- with(Biomass_Global_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Biomass_Global_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T),  Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), ForestAge = median(ForestAge, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T), WWFBiome = median(WWFBiome)))

H1_cut <- quantile(Biomass_Global_Scaled$H1, c(0.04, .2, .58, 1), na.rm=T) #Global
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

all_dat$WWFBiome <- "7"
all_dat$WWFBiome <- as.numeric(all_dat$WWFBiome)
all_datGlobal <- all_dat %>% mutate(BiomassYr = predict(Global_Biomass_Projection, newdata = all_dat))

#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>%
  mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Biomass_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>%
  mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Biomass_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>%
  mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Biomass_H1_lower"="prod_pred"))  

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datTrop, file="GraphGlobalBiomass2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphGlobalBiomass.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
maxBiomass <- Biomass_Global %>% summarise(quants = quantile(BiomassYr), probs = c(0.25)) 
maxBiomass <- as.data.frame(maxBiomass)

GlobalGraphBiomass <- ggplot(all_datGlobal, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+ 
  ggtitle('Global')+
  theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.6", "0.6-0.8", "0.8-1"), name="Evenness")+
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
  xlab("Species richness") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(3000, 8000)) + xlim(c(0,170)) +
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

#Variable importance richness, evenness and interaction
BiomassREIGlobal <- subset(BiomassREI, BiomeName == "Global")

GlobalREI <-  ggplot(data = BiomassREIGlobal, aes(y = BiomassREIGlobal$VarImportance, x = BiomassREIGlobal$BiomeName, 
                                                    fill = reorder(factor(BiomassREIGlobal$Topic), desc(factor(BiomassREIGlobal$Topic))))) + 
  geom_bar(stat="identity", position = "fill") + scale_fill_manual(values=c ("#647fed", "#0911ab", "#76bd60")) +
  ylab("Variable importance (%)") + xlab(" ") + ggtitle(' ') + scale_y_continuous(labels = function(l) {trans = l * 100 }) +
  theme_classic() + theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
                          legend.position = "none",
                          axis.text.x = element_text(size = 14, face = "bold", color ="white"),
                          axis.title.y = element_text(size = 16, face = "bold"),
                          axis.text.y = element_text(size = 14, face = "bold")) 

GlobalBiomass <- grid.arrange(GlobalGraphBiomass, GlobalREI,                           
                             layout_matrix = matrix(c(1,1,1,1, 2), 1, 5, byrow = TRUE))

###Adding several graphs in one figure
margin = theme(plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"))
Fig4B <- grid.arrange(GlobalGraphBiomass,BorealGraphBiomass, 
             TemperateGraphBiomass, 
             TropicalGraphBiomass,                               
             layout_matrix = matrix(c(1,1,2,
                                      1,1,3,
                                      1,1,4), 3, 3, byrow = TRUE))

```
###Null model Fig.S1 
```{r Null model}
gfo <- fread("~/Documents/PhD projects/Traits Dominant species/GFBI_rarefied.csv") %>% mutate(plot_id = as.integer(gsub("p","",plot_id))) %>% 
	select(plot_id, raw_name, tph) %>% rename(accepted_bin = raw_name) %>% group_by(plot_id, accepted_bin) %>% 
	summarize(tph = round(sum(tph))) %>% ungroup 

# tally up the number of tph
enough_plots <- gfo %>% group_by(plot_id) %>% summarize(n = sum(tph)) %>% arrange(n) %>% filter(n>1)

# only keep those plots with more than 1 tph
gfo <- gfo %>% filter(plot_id%in%enough_plots$plot_id)

# add up trees per species per plot
gf <- gfo %>% group_by(plot_id) %>% summarize(S = length(tph), sha = diversity(tph)) %>% mutate(E = exp(sha)/S-1) %>% mutate(log_S = log(S)) 

# get the observed correlation
obs_slope <- summary(lm(E~-1+log_S, data = gf))$coefficients[1,1]

nsim <- 10
null_slope <- rep(NA, nsim)
Evenness_slope <- rep(NA, nsim)
Richness_slope <- rep(NA, nsim)

for(i in 1:nsim){
	print(i)
	
	# sample from a multinomial distribution
	my_gfo <- gfo %>% group_by(plot_id) %>% 
	  #  mutate(tph = rpareto(length(tph), shape = 1)) #Less neg (100)
	  #  mutate(tph = rbinom(length(tph), size=0, prob =  0.5)) #Less neg (100)
	    mutate(tph = rlogseries(length(tph), prob =  0.95)) #More neg (100)
	  #  mutate(tph = rpois(length(tph), lambda = 0.1)) #Less neg (100)
		#  mutate(tph = rlnorm(length(tph), meanlog = log(mean(tph)), sdlog = 1)) #Less neg (100)
	  #  mutate(tph = rmultinom(1, sum(tph), prob = rep(1/length(tph), time = length(tph)))) #More neg (10000)
	
	# calculate richness/evenness
	my_gf <- my_gfo %>% group_by(plot_id) %>% summarize(S = length(tph), sha = diversity(tph)) %>% mutate(E = exp(sha)/S-1) %>% mutate(log_S = log(S))
	
	# get the correlation
	null_slope[i] <- summary(lm(E~-1+log_S, data = my_gf))$coefficients[1,1]
}

ggplot(gf, aes(x=log_S, y=E+1))+geom_point()+geom_abline(intercept = 1, slope = obs_slope) + geom_abline(intercept = 1, slope = min(null_slope), color="red")+
  geom_abline(intercept = 1, slope = max(null_slope), color="red")

null_slope <- as.data.frame(null_slope)
null_slope$data <- null_slope[1,]

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(null_slope, file="Data_NullModelMultinomial.csv")

null_slope <- fread("~/Documents/PhD projects/Biomass/Data_NullModelMultinomial.csv")

g1 <- ggplot(null_slope, aes(x=null_slope))+geom_histogram(color="black", fill="white", bins=10000, binwidth=0.001)+ #, binwidth=0.01
  geom_vline(xintercept = obs_slope, color = "darkgreen", size=3)+
  theme_bw() +
  xlab("Slope Evenness-log(S)")+ ylab("Density") + labs(title="Null model") + xlim(-0.14, 0) +
  theme(plot.title = element_text(hjust = 0.5, size = 19, face = "bold"),
        axis.title.x = element_text(size = 16),
        axis.text.x = element_text(size = 18),
        axis.title.y = element_text(size = 16),
        axis.text.y = element_text(size = 18)) 
g1
```

###Relationship evenness-richness other evenness indices Fig.S2
```{r Relationship R-E SI}

SE_Global$Pielou <- SE_Global$Diversity/log(SE_Global$S)

cor.test(log(SE_Global$S), SE_Global$H1Stand, method = c("pearson")) #r=-0.12, df=18023, p<0.001
cor.test(log(SE_Global$S), SE_Global$Evar, method = c("pearson")) #r=-0.10, df=18025, p<0.001
cor.test(log(SE_Global$S), SE_Global$Simpson, method = c("pearson")) #r=-0.65, df=19710, p<0.001
cor.test(log(SE_Global$S), SE_Global$PIE, method = c("pearson")) #r=-0.85, df=19710, p<0.001
cor.test(log(SE_Global$S), SE_Global$Eq, method = c("pearson")) #r=-0.13, df=18025, p<0.001
cor.test(log(SE_Global$S), SE_Global$Pielou, method = c("pearson")) #r=0.24, df=18023, p<0.001

summary(lm(H1Stand~log(S), data=SE_Global)) #r2=0.01
summary(lm(Evar~log(S), data=SE_Global)) #r2=0.008
summary(lm(Simpson~log(S), data=SE_Global)) #r2=0.42
summary(lm(PIE~log(S), data=SE_Global)) #r2=0.71
summary(lm(Eq~log(S), data=SE_Global)) #r2=0.02
summary(lm(Pielou~log(S), data=SE_Global)) #r2=0.06

paletteForUse <- c('#d10000', '#ff6622', '#ffda21', '#33dd00', '#1133cc', '#220066', '#330044')
colors <-  colorRampPalette(paletteForUse)(256)
SE_Global$dens <- col2rgb(densCols(SE_Global$H1Stand, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]
H1Stand <- ggplot(SE_Global, aes(log(S), H1Stand)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ #ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("Hill's evenness normalised")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Global$dens <- col2rgb(densCols(SE_Global$Evar, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]
Evar <- ggplot(SE_Global, aes(log(S), Evar)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ #ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("Evar")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Global$dens <- col2rgb(densCols(SE_Global$Simpson, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]
Simpson <- ggplot(SE_Global, aes(log(S), Simpson)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ #ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("Simpson's evenness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Global$dens <- col2rgb(densCols(SE_Global$PIE, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]
PIE <- ggplot(SE_Global, aes(log(S), PIE)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ #ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("PIE")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Global$dens <- col2rgb(densCols(SE_Global$Eq, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]
Eq <- ggplot(SE_Global, aes(log(S), Eq)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ #ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("Eq")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

SE_Global$dens <- col2rgb(densCols(SE_Global$Pielou, log(SE_Global$S)))[1,] + 1L
SE_Global$colors = colors[SE_Global$dens]
Pielou <- ggplot(SE_Global, aes(log(S), Pielou)) +
  geom_point(color= SE_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ #ggtitle("Global relationship Evenness - Species richness")+
  xlab("Species richness") + ylab("Pielou's J")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

FigS2 <- grid.arrange(H1Stand, Evar, Simpson, PIE, Eq, Pielou, nrow=2)
```

###Relationship evenness-richness different scales Fig.S4
```{r Evenness-Richness across scales}
# Relationship E-S with scale
# results_scales_0005degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_0005degree.csv")
# results_scales_0005degree <- results_scales_0005degree[,-c(14)]
# results_scales_001degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_001degree.csv")
# results_scales_005degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_005degree.csv")
# results_scales_01degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_01degree.csv")
# results_scales_01degree <- results_scales_01degree[,c("V1","CorCoef_J","Pvalue_J","Continent","BiomeResolve_reduced","WWF_Biome", "Climate_class", "Resolve_Biome", "Scale","CorCoef_Evar","Pvalue_Evar","CorCoef_H1","Pvalue_H1","CorCoef_H2","Pvalue_H2")]
# results_scales_05degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_05degree.csv")
# results_scales_1degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_1degree.csv")
# results_scales_5degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_5degree.csv")
# results_scales_10degree <- fread("~/Documents/PhD projects/Relationship S-E/relationship_scales_10degree.csv")
#
# results_scales_relationship <- rbind(results_scales_0005degree, results_scales_001degree, results_scales_005degree, results_scales_01degree, results_scales_05degree,
#                                      results_scales_1degree, results_scales_5degree, results_scales_10degree)
#
# unique(results_scales_relationship$WWF_Biome)
# table(results_scales_relationship$WWF_Biome)
# names(results_scales_relationship)
#
# results_scales_relationship$WWF_Biome[results_scales_relationship$WWF_Biome == 4.5] <- 5
# results_scales_relationship$WWF_Biome[results_scales_relationship$WWF_Biome == 5.5] <- 6
# results_scales_relationship$WWF_Biome[results_scales_relationship$WWF_Biome == 8.5] <- 9
#
# summary(results_scales_relationship)
# head(results_scales_relationship)
# results_scales_relationship <- results_scales_relationship[complete.cases(results_scales_relationship), ]
#
# detach(package:plyr)
# scales_relationship <- results_scales_relationship %>% group_by(WWF_Biome, Scale) %>% summarise(meanCoef = mean(CorCoef_H1))
# scales_relationship <- as.data.frame(scales_relationship)
# names(scales_relationship)
#
# ggplot(data=scales_relationship, aes(x=Scale, y=meanCoef)) +
#   geom_point(aes(group = WWF_Biome, colour = factor(WWF_Biome), shape = ), size=5) +
#   theme_minimal()  +
#   #scale_color_brewer(palette="Set1", name = "Legend")+
#   xlab("Scale (km)") + theme(axis.text.x = element_text(size=14),
#                              axis.text.y = element_text(size=12),
#                              axis.title.x = element_text(size=17),
#                              axis.title.y = element_text(size=17))+
#   ylab("Correlation Coefficient") +
#   ggtitle("Scale relationship S - E") +
#   theme(plot.title = element_text(size=20, hjust = 0.5)) +
#   scale_x_discrete(labels=c("0005_Degree" = "0.5", "001_Degree" = "1","005_Degree" = "5.5","01_Degree" = "11","05_Degree" = "55",
#                             "1_Degree"="110","5_Degree"="550","10_Degree"="1100"))
#
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 1] <- 300
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 2] <- 300
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 3] <- 300
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 4] <- 200
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 5] <- 200
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 6] <- 100
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 7] <- 300
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 8] <- 200
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 9] <- 300
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 10] <- 300
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 11] <- 100
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 12] <- 200
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome == 13] <- 400
#
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome_reduced == 100] <- 1
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome_reduced == 200] <- 2
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome_reduced == 300] <- 3
# results_scales_relationship$WWF_Biome_reduced[results_scales_relationship$WWF_Biome_reduced == 400] <- 4
#
# names(results_scales_relationship)
# summary(results_scales_relationship)
#
# scales_relationship_reduced <- results_scales_relationship %>% group_by(WWF_Biome_reduced, Scale) %>% summarise(meanCoef = mean(CorCoef_H1))
# scales_relationship_reduced <- as.data.frame(scales_relationship_reduced)
# names(scales_relationship_reduced)
#
# setwd("~/Documents/PhD projects/Relationship S-E")
# write.csv( scales_relationship_reduced, file= "scales_relationship_BiomesReduced.csv")

scales_relationship_red <- fread("~/Documents/PhD projects/Relationship S-E/scales_relationship_BiomesReduced.csv")
names(scales_relationship_red)

ggplot(data=scales_relationship_red, aes(x=Scale, y=meanCoef)) + 
  geom_point(aes(group = WWF_Biome_reduced, colour = factor(WWF_Biome_reduced), shape=factor(Sig)), size=7, show.legend = FALSE) + 
  geom_line(aes(group = WWF_Biome_reduced, colour = factor(WWF_Biome_reduced))) +
  theme_minimal()  + 
  scale_shape_manual(values=c(1, 16)) +
  scale_color_manual(values=c("darkgreen", "blue", "orange"), labels = c("Boreal biomes", "Temperate biomes", "Tropical biomes", "Desert")) +
  xlab("Scale (km)") + theme(legend.title = element_blank(),
                             legend.text=element_text(size=16),
                             plot.title = element_text(face = "bold"),
                             axis.text.x = element_text(size=16), 
                             axis.text.y = element_text(size=16),
                             axis.title.x = element_text(size=18, face = "bold"),
                             axis.title.y = element_text(size=18, face = "bold")) +
  ylab("Correlation Coefficient") + 
  ggtitle("Relationship Evenness - Species richness") + 
  theme(plot.title = element_text(size=20, hjust = 0.5)) +
  scale_x_discrete(limits=c("0005_Degree", "001_Degree", "005_Degree", "01_Degree", "05_Degree", "1_Degree", "5_Degree", "10_Degree"), 
                   labels=c("0005_Degree" = "0.5", "001_Degree" = "1","005_Degree" = "5.5","01_Degree" = "11","05_Degree" = "55",
                            "1_Degree"="110","5_Degree"="550","10_Degree"="1100")) 
```
###Plotsize graphs:low-median-high Fig.S5
```{r Effect plotsize, include=FALSE}
ProductivityFinal <- fread("~/Documents/PhD projects/Biomass/NPP_24.11.2021.csv")
summary(ProductivityFinal$Plotsize)

RelSmallPs <- ProductivityFinal[which(ProductivityFinal$Plotsize<0.03148),]
RelMediumPs <- ProductivityFinal[which(ProductivityFinal$Plotsize>0.03148 & ProductivityFinal$Plotsize<0.06315),]
RelLargePs <- ProductivityFinal[which(ProductivityFinal$Plotsize>0.06315),]  

set.seed(10)
Biome1_Small <- RelSmallPs %>% filter(Biome==1) %>% sample_n(215)
Biome2_Small <- RelSmallPs %>% filter(Biome==2) %>% sample_n(52)
Biome3_Small <- RelSmallPs %>% filter(Biome==3) %>% sample_n(29)
Biome4_Small <- RelSmallPs %>% filter(Biome==4) %>% sample_n(3039)
Biome5_Small <- RelSmallPs %>% filter(Biome==5) %>% sample_n(1233)
Biome6_Small <- RelSmallPs %>% filter(Biome==6) %>% sample_n(5072)
Biome7_Small <- RelSmallPs %>% filter(Biome==7) %>% sample_n(54)
Biome8_Small <- RelSmallPs %>% filter(Biome==8) %>% sample_n(540)
Biome9_Small <- RelSmallPs %>% filter(Biome==9) %>% sample_n(87)
Biome10_Small <- RelSmallPs %>% filter(Biome==10) %>% sample_n(6)
Biome11_Small <- RelSmallPs %>% filter(Biome==11) %>% sample_n(506)
Biome12_Small <- RelSmallPs %>% filter(Biome==12) %>% sample_n(303)
Biome13_Small <- RelSmallPs %>% filter(Biome==13) %>% sample_n(231)
Biome14_Small <- RelSmallPs %>% filter(Biome==14) %>% sample_n(4)

RelSmall_Global <- rbind(Biome1_Small, Biome2_Small, Biome3_Small, Biome4_Small, Biome5_Small, Biome6_Small, Biome7_Small, Biome8_Small, Biome9_Small, Biome10_Small, Biome11_Small, Biome12_Small,Biome13_Small, Biome14_Small)

set.seed(10)
Biome1_Medium <- RelMediumPs %>% filter(Biome==1) %>% sample_n(2766)
Biome2_Medium <- RelMediumPs %>% filter(Biome==2) %>% sample_n(52)
Biome3_Medium <- RelMediumPs %>% filter(Biome==3) %>% sample_n(214)
Biome4_Medium <- RelMediumPs %>% filter(Biome==4) %>% sample_n(3039)
Biome5_Medium <- RelMediumPs %>% filter(Biome==5) %>% sample_n(1233)
Biome6_Medium <- RelMediumPs %>% filter(Biome==6) %>% sample_n(5072)
Biome7_Medium <- RelMediumPs %>% filter(Biome==7) %>% sample_n(478)
Biome8_Medium <- RelMediumPs %>% filter(Biome==8) %>% sample_n(540)
Biome9_Medium <- RelMediumPs %>% filter(Biome==9) %>% sample_n(182)
Biome10_Medium <- RelMediumPs %>% filter(Biome==10) %>% sample_n(130)
Biome11_Medium <- RelMediumPs %>% filter(Biome==11) %>% sample_n(506)
Biome12_Medium <- RelMediumPs %>% filter(Biome==12) %>% sample_n(303)
Biome13_Medium <- RelMediumPs %>% filter(Biome==13) %>% sample_n(231)
Biome14_Medium <- RelMediumPs %>% filter(Biome==14) %>% sample_n(11)

RelMedium_Global <- rbind(Biome1_Medium, Biome2_Medium, Biome3_Medium, Biome4_Medium, Biome5_Medium, Biome6_Medium, Biome7_Medium, Biome8_Medium, Biome9_Medium, Biome10_Medium, Biome11_Medium, Biome12_Medium,Biome13_Medium, Biome14_Medium)

set.seed(10)
Biome1_Large <- RelLargePs %>% filter(Biome==1) %>% sample_n(3675)
Biome2_Large <- RelLargePs %>% filter(Biome==2) %>% sample_n(52)
Biome3_Large <- RelLargePs %>% filter(Biome==3) %>% sample_n(214)
Biome4_Large <- RelLargePs %>% filter(Biome==4) %>% sample_n(3039)
Biome5_Large <- RelLargePs %>% filter(Biome==5) %>% sample_n(1233)
Biome6_Large <- RelLargePs %>% filter(Biome==6) %>% sample_n(1827)
Biome7_Large <- RelLargePs %>% filter(Biome==7) %>% sample_n(873)
Biome8_Large <- RelLargePs %>% filter(Biome==8) %>% sample_n(540)
Biome9_Large <- RelLargePs %>% filter(Biome==9) %>% sample_n(77)
Biome10_Large <- RelLargePs %>% filter(Biome==10) %>% sample_n(168)
Biome11_Large <- RelLargePs %>% filter(Biome==11) %>% sample_n(393)
Biome12_Large <- RelLargePs %>% filter(Biome==12) %>% sample_n(303)
Biome13_Large <- RelLargePs %>% filter(Biome==13) %>% sample_n(231)
Biome14_Large <- RelLargePs %>% filter(Biome==14) %>% sample_n(19)

RelLarge_Global <- rbind(Biome1_Large, Biome2_Large, Biome3_Large, Biome4_Large, Biome5_Large, Biome6_Large, Biome7_Large, Biome8_Large, Biome9_Large, Biome10_Large, Biome11_Large, Biome12_Large,Biome13_Large, Biome14_Large)

#cor.test(log(SE_Global$S), SE_Global$H1, method = c("pearson")) #r=-0.53, df=19710, p<0.001
cor.test(log(RelSmall_Global$S), RelSmall_Global$H1, method = c("pearson")) #r=-0.53, p<0.001
cor.test(log(RelMedium_Global$S), RelMedium_Global$H1, method = c("pearson")) #r=-0.35, p<0.001
cor.test(log(RelLarge_Global$S), RelLarge_Global$H1, method = c("pearson")) #r=-0.52, p<0.001

#summary(lm(H1~log(S), data=SE_Global)) #r2=0.28
summary(lm(H1~log(S), data=RelSmall_Global)) #r2=0.28
summary(lm(H1~log(S), data=RelMedium_Global)) #r2=0.13
summary(lm(H1~log(S), data=RelLarge_Global)) #r2=0.27

#SE_Global$logS <- log(SE_Global$S)
RelSmall_Global$logS <- log(RelSmall_Global$S)
RelMedium_Global$logS <- log(RelMedium_Global$S)
RelLarge_Global$logS <- log(RelLarge_Global$S)

###Graphs
paletteForUse <- c('#d10000', '#ff6622', '#ffda21', '#33dd00', '#1133cc', '#220066', '#330044')
colors <-  colorRampPalette(paletteForUse)(256)
RelSmall_Global$dens <- col2rgb(densCols(RelSmall_Global$H1, RelSmall_Global$logS))[1,] + 1L
RelSmall_Global$colors = colors[RelSmall_Global$dens]

Small_SE <- ggplot(RelSmall_Global, aes(logS, H1)) +
  geom_point(color= RelSmall_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ ggtitle("Evenness - Richness Small plotsize")+
  xlab("Species richness") + ylab("Evenness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

RelMedium_Global$dens <- col2rgb(densCols(RelMedium_Global$H1, RelMedium_Global$logS))[1,] + 1L
RelMedium_Global$colors = colors[RelMedium_Global$dens]

Medium_SE <- ggplot(RelMedium_Global, aes(logS, H1)) +
  geom_point(color= RelMedium_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ ggtitle("Evenness - Richness Medium plotsize")+
  xlab("Species richness") + ylab("Evenness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

RelLarge_Global$dens <- col2rgb(densCols(RelLarge_Global$H1, RelLarge_Global$logS))[1,] + 1L
RelLarge_Global$colors = colors[RelLarge_Global$dens]

Large_SE <- ggplot(RelLarge_Global, aes(logS, H1)) +
  geom_point(color= RelLarge_Global$colors)+#stat_smooth(method = "lm", se = TRUE, level=0.95, formula = y ~ x + I(x^2) +I(x^3), size = 2, colour="#0a0a0a") +
  geom_smooth(se = TRUE, level=0.95, size= 2, colour="#0a0a0a", method="lm") + #annotate("text", label = "Pearson's r = -0.53", x = 5, y = 1, size = 6, colour = "black") +
  scale_x_continuous(breaks=c(0, 2, 4, 6), labels=c("1","8","55","400"), limits=c(0,6)) +
  ylim(0,1)+theme_classic()+ ggtitle("Evenness - Richness Large plotsize")+
  xlab("Species richness") + ylab("Evenness")+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14),
        legend.title = element_blank(),
        legend.text = element_blank()) +
  guides(size=FALSE)

Small_SE <- ggMarginal(Small_SE, type="boxplot", size=20)
Medium_SE <- ggMarginal(Medium_SE, type="boxplot", size=20)
Large_SE <- ggMarginal(Large_SE, type="boxplot", size=20)

margin = theme(plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"))
FigSPs <- grid.arrange(Small_SE, Medium_SE, Large_SE, nrow=1)

##################NPP interaction graph
Global_Npp <- RelLarge_Global #RelSmall_Global #RelMedium_Global #RelLarge_Global
Global_Npp <- Global_Npp[complete.cases(Global_Npp), ]

#Projections
DepVar <- Global_Npp[, c("S", "Biome", "Diversity", "H1", "Npp", "Plotsize", "Plot_ID")]
IndVar <- Global_Npp[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Global_Npp$Plot_ID)
setnames(scaled, old = c("Global_Npp$Plot_ID"), new = c("Plot_ID"))
Global_Npp_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(H1~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

H1_cut <- c(0.4, 0.6, 0.8, 1) #Global
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

#all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
#all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Npp_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Npp_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Npp_H1_lower"="prod_pred"))  
#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
summary(all_datGlobal$S)

Global_SmallPs <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(H1))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.6", "0.6-0.8", "0.8-1"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("NPP Small plotsize") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(3000, 9000)) + xlim(c(0,25)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

Global_MediumPs <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(H1))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a")) +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("NPP Medium plotsize") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(2000, 11000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

Global_LargePs <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(H1))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a")) +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("NPP Large plotsize") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12000, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

FigSNppPs <- grid.arrange(Global_SmallPs, Global_MediumPs, Global_LargePs, nrow=1)

##################Biomass interaction graph
Biomass <- fread("~/Documents/PhD projects/Biomass/Biomass20.08.2020.csv")
Biomass$TreesPerHa <- round(Biomass$treeNumber/Biomass$plotArea, 0)

BiomassSmallPs <- Biomass[which(Biomass$Plotsize<0.03652),]
BiomassMediumPs <- Biomass[which(Biomass$Plotsize>0.03652 & Biomass$Plotsize<0.06727),]
BiomassLargePs <- Biomass[which(Biomass$Plotsize>0.06727),]  

#Global datasample 
set.seed(10)
Biomass_Biome1_Small <- BiomassSmallPs %>% filter(WWFBiome==1) %>% sample_n(66)
Biomass_Biome2_Small <- BiomassSmallPs %>% filter(WWFBiome==2) %>% sample_n(100)
Biomass_Biome4_Small <- BiomassSmallPs %>% filter(WWFBiome==4) %>% sample_n(1348)
Biomass_Biome5_Small <- BiomassSmallPs %>% filter(WWFBiome==5) %>% sample_n(547)
Biomass_Biome6_Small <- BiomassSmallPs %>% filter(WWFBiome==6) %>% sample_n(2250)
Biomass_Biome7_Small <- BiomassSmallPs %>% filter(WWFBiome==7) %>% sample_n(30)
Biomass_Biome8_Small <- BiomassSmallPs %>% filter(WWFBiome==8) %>% sample_n(200)
Biomass_Biome9_Small <- BiomassSmallPs %>% filter(WWFBiome==9) %>% sample_n(1)
Biomass_Biome10_Small <- BiomassSmallPs %>% filter(WWFBiome==10) %>% sample_n(7)
Biomass_Biome11_Small <- BiomassSmallPs %>% filter(WWFBiome==11) %>% sample_n(225)
Biomass_Biome12_Small <- BiomassSmallPs %>% filter(WWFBiome==12) %>% sample_n(134)
Biomass_Biome13_Small <- BiomassSmallPs %>% filter(WWFBiome==13) %>% sample_n(102)

Biomass_SmallPs <- rbind(Biomass_Biome1_Small, Biomass_Biome2_Small, Biomass_Biome4_Small, Biomass_Biome5_Small, Biomass_Biome6_Small, Biomass_Biome7_Small, Biomass_Biome8_Small, Biomass_Biome9_Small, Biomass_Biome10_Small, Biomass_Biome11_Small, Biomass_Biome12_Small, Biomass_Biome13_Small)

set.seed(10)
Biomass_Biome1_Medium <- BiomassMediumPs %>% filter(WWFBiome==1) %>% sample_n(1735)
Biomass_Biome2_Medium <- BiomassMediumPs %>% filter(WWFBiome==2) %>% sample_n(100)
Biomass_Biome4_Medium <- BiomassMediumPs %>% filter(WWFBiome==4) %>% sample_n(1348)
Biomass_Biome5_Medium <- BiomassMediumPs %>% filter(WWFBiome==5) %>% sample_n(547)
Biomass_Biome6_Medium <- BiomassMediumPs %>% filter(WWFBiome==6) %>% sample_n(2250)
Biomass_Biome7_Medium <- BiomassMediumPs %>% filter(WWFBiome==7) %>% sample_n(267)
Biomass_Biome8_Medium <- BiomassMediumPs %>% filter(WWFBiome==8) %>% sample_n(200)
Biomass_Biome9_Medium <- BiomassMediumPs %>% filter(WWFBiome==9) %>% sample_n(1)
Biomass_Biome10_Medium <- BiomassMediumPs %>% filter(WWFBiome==10) %>% sample_n(109)
Biomass_Biome11_Medium <- BiomassMediumPs %>% filter(WWFBiome==11) %>% sample_n(225)
Biomass_Biome12_Medium <- BiomassMediumPs %>% filter(WWFBiome==12) %>% sample_n(134)
Biomass_Biome13_Medium <- BiomassMediumPs %>% filter(WWFBiome==13) %>% sample_n(102)

Biomass_MediumPs <- rbind(Biomass_Biome1_Medium, Biomass_Biome2_Medium, Biomass_Biome4_Medium, Biomass_Biome5_Medium, Biomass_Biome6_Medium, Biomass_Biome7_Medium, Biomass_Biome8_Medium, Biomass_Biome9_Medium, Biomass_Biome10_Medium, Biomass_Biome11_Medium, Biomass_Biome12_Medium, Biomass_Biome13_Medium)

set.seed(10)
Biomass_Biome1_Large <- BiomassLargePs %>% filter(WWFBiome==1) %>% sample_n(1826)
Biomass_Biome2_Large <- BiomassLargePs %>% filter(WWFBiome==2) %>% sample_n(100)
Biomass_Biome4_Large <- BiomassLargePs %>% filter(WWFBiome==4) %>% sample_n(1348)
Biomass_Biome5_Large <- BiomassLargePs %>% filter(WWFBiome==5) %>% sample_n(547)
Biomass_Biome6_Large <- BiomassLargePs %>% filter(WWFBiome==6) %>% sample_n(603)
Biomass_Biome7_Large <- BiomassLargePs %>% filter(WWFBiome==7) %>% sample_n(552)
Biomass_Biome8_Large <- BiomassLargePs %>% filter(WWFBiome==8) %>% sample_n(200)
Biomass_Biome9_Large <- BiomassLargePs %>% filter(WWFBiome==9) %>% sample_n(1)
Biomass_Biome10_Large <- BiomassLargePs %>% filter(WWFBiome==10) %>% sample_n(109)
Biomass_Biome11_Large <- BiomassLargePs %>% filter(WWFBiome==11) %>% sample_n(65)
Biomass_Biome12_Large <- BiomassLargePs %>% filter(WWFBiome==12) %>% sample_n(134)
Biomass_Biome13_Large <- BiomassLargePs %>% filter(WWFBiome==13) %>% sample_n(102)

Biomass_LargePs <- rbind(Biomass_Biome1_Large, Biomass_Biome2_Large, Biomass_Biome4_Large, Biomass_Biome5_Large, Biomass_Biome6_Large, Biomass_Biome7_Large, Biomass_Biome8_Large, Biomass_Biome9_Large, Biomass_Biome10_Large, Biomass_Biome11_Large, Biomass_Biome12_Large, Biomass_Biome13_Large)

#Data
Biomass_Global <- Biomass_LargePs #Biomass_SmallPs #Biomass_MediumPs #Biomass_LargePs
Biomass_Global <- Biomass_Global[complete.cases(Biomass_Global), ]

#Projections
DepVar <- Biomass_Global[, c("S", "WWFBiome", "Diversity", "H1", "BiomassYr", "Plotsize", "Plot_ID")]
IndVar <- Biomass_Global[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "ForestAge", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Biomass_Global$Plot_ID)
setnames(scaled, old = c("Biomass_Global$Plot_ID"), new = c("Plot_ID"))
Biomass_Global_Scaled <- merge(scaled, DepVar, by="Plot_ID")

#Model with environmental conditions
Global_Biomass_Projection <- lm(BiomassYr ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 ForestAge + factor(WWFBiome),data=Biomass_Global_Scaled)  

Model_ES <- gam(H1~S, data=Biomass_Global_Scaled)
Data_ES <- with(Biomass_Global_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)

#Median variables
dummy_dat <- with(Biomass_Global_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), ForestAge = median(ForestAge, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T), WWFBiome = as.numeric(names(sort(table(Biomass_Global_Scaled$WWFBiome), decreasing = TRUE)))[1]))

H1_cut <- c(0.4, 0.6, 0.8, 1) #Global
H1_cut

all_dat <- tibble()

for(i in 1:length(H1_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}

#all_dat$WWFBiome <- "7"
#all_dat$WWFBiome <- as.numeric(all_dat$WWFBiome)
all_datGlobal <- all_dat %>% mutate(BiomassYr = predict(Global_Biomass_Projection, newdata = all_dat))

#H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>%
  mutate(WWFBiome = as.numeric(names(sort(table(Biomass_Global_Scaled$WWFBiome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Biomass_H1_mean"="prod_pred"))  

Data_ES_H1up <- Data_ES 
Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>%
  mutate(WWFBiome = as.numeric(names(sort(table(Biomass_Global_Scaled$WWFBiome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Biomass_H1_upper"="prod_pred"))  

Data_ES_H1low <- Data_ES 
Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>%
  mutate(WWFBiome = as.numeric(names(sort(table(Biomass_Global_Scaled$WWFBiome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Biomass_H1_lower"="prod_pred"))  

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datTrop, file="GraphGlobalBiomass2021.csv")

#all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphGlobalBiomass.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
summary(all_datGlobal$S)

GlobalGraphBiomass_SmallPs <- ggplot(all_datGlobal, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+  ggtitle('Biomass Small plotsize')+  theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.6", "0.6-0.8", "0.8-1"), name="Evenness")+
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
  xlab("Species richness") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(0,2500)) + xlim(c(0,20)) +
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

GlobalGraphBiomass_MediumPs <- ggplot(all_datGlobal, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+ ggtitle('Biomass Medium plotsize')+ theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"))+
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
  xlab("Species richness") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(0, 30000)) + xlim(c(0,125)) +
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position ="none",
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

GlobalGraphBiomass_LargePs <- ggplot(all_datGlobal, aes(x=S, y=BiomassYr,color=factor(H1)))+
  geom_point()+ ggtitle('Biomass Large plotsize')+theme_classic()+
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"))+
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
  xlab("Species richness") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(3000, 8000)) + xlim(c(0,170)) +
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

FigSBiomassPs <- grid.arrange(GlobalGraphBiomass_SmallPs, GlobalGraphBiomass_MediumPs, GlobalGraphBiomass_LargePs, nrow=1)

FigSI5 <- grid.arrange(FigSPs, FigSNppPs, FigSBiomassPs, nrow=3)
```

###Interaction graph NPP other evenness indices Fig.S6
```{r Interaction NPP & other Evenness indices}

Global_Npp <- SE_Global
Global_Npp <- Global_Npp[complete.cases(Global_Npp), ]

Global_Npp$SecondaryForest <- Global_Npp$GFAD_FractionOfRegrowthForest_downsampled50km 

#Projections
DepVar <- Global_Npp[, c("S", "Biome", "Diversity", "H1Stand", "Simpson", "Evar", "PIE", "Pielou", "Eq",  "Npp", "Plotsize", "Plot_ID")]
IndVar <- Global_Npp[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data

scaled <- cbind(IndVar.scaled, Global_Npp$Plot_ID)
setnames(scaled, old = c("Global_Npp$Plot_ID"), new = c("Plot_ID"))
Global_Npp_Scaled <- merge(scaled, DepVar, by="Plot_ID")

###############################################################################H1 normalised
#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*H1Stand + S + H1Stand + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(H1Stand~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(H1Stand = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                H1Stand_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(H1Stand_upper = H1Stand+1.96*H1Stand_se, H1Stand_lower = H1Stand-1.96*H1Stand_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

H1Stand_cut <- quantile(Global_Npp_Scaled$H1Stand, c(0.1, 0.5, 0.9), na.rm=T) #Global
H1Stand_cut

all_dat <- tibble()

for(i in 1:length(H1Stand_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1Stand = H1Stand_cut[i]))}

all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, H1Stand) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "H1Stand", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("H1Stand_mean"="H1Stand", "Npp_H1Stand_mean"="prod_pred"))  

Data_ES_H1Standup <- Data_ES 
Data_ES_H1Standup$H1Stand <- Data_ES_H1Standup$H1Stand_upper
Data_ES_upper <- Data_ES_H1Standup %>% dplyr::select(S, H1Stand) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1Standup)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "H1Stand", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("H1Stand_upper"="H1Stand", "Npp_H1Stand_upper"="prod_pred"))  

Data_ES_H1Standlow <- Data_ES 
Data_ES_H1Standlow$H1Stand <- Data_ES_H1Standlow$H1Stand_lower
Data_ES_lower <- Data_ES_H1Standlow %>% dplyr::select(S, H1Stand) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1Standlow)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "H1Stand", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("H1Stand_lower"="H1Stand", "Npp_H1Stand_lower"="prod_pred"))  
#H1Stand_upper, H1Stand_lower ipv H1Stand and predict again. 3 predicted lines in the end: H1Stand high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
Global_H1Stand <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(H1Stand))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.7", "0.7-0.9"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("Normalised Hill's evenness") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12500, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1Stand_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1Stand_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1Stand_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###############################################################################Simpson 
#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*Simpson + S + Simpson + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(Simpson~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(Simpson = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                Simpson_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(Simpson_upper = Simpson+1.96*Simpson_se, Simpson_lower = Simpson-1.96*Simpson_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T),Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

Simpson_cut <- quantile(Global_Npp_Scaled$Simpson, c(0.1, 0.5, 0.9), na.rm=T) #Global
Simpson_cut

all_dat <- tibble()

for(i in 1:length(Simpson_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Simpson = Simpson_cut[i]))}

all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, Simpson) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "Simpson", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("Simpson_mean"="Simpson", "Npp_Simpson_mean"="prod_pred"))  

Data_ES_Simpsonup <- Data_ES 
Data_ES_Simpsonup$Simpson <- Data_ES_Simpsonup$Simpson_upper
Data_ES_upper <- Data_ES_Simpsonup %>% dplyr::select(S, Simpson) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Simpsonup)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "Simpson", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("Simpson_upper"="Simpson", "Npp_Simpson_upper"="prod_pred"))  

Data_ES_Simpsonlow <- Data_ES 
Data_ES_Simpsonlow$Simpson <- Data_ES_Simpsonlow$Simpson_lower
Data_ES_lower <- Data_ES_Simpsonlow %>% dplyr::select(S, Simpson) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Simpsonlow)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "Simpson", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("Simpson_lower"="Simpson", "Npp_Simpson_lower"="prod_pred"))  
#Simpson_upper, Simpson_lower ipv Simpson and predict again. 3 predicted lines in the end: Simpson high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
Global_Simpson <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(Simpson))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.6", "0.6-0.9"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("Simpson's evenness") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12500, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Simpson_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Simpson_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Simpson_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###############################################################################Evar
#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*Evar + S + Evar + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(Evar~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(Evar = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                Evar_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(Evar_upper = Evar+1.96*Evar_se, Evar_lower = Evar-1.96*Evar_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

Evar_cut <- quantile(Global_Npp_Scaled$Evar, c(0.1, 0.5, 0.9), na.rm=T) #Global
Evar_cut

all_dat <- tibble()

for(i in 1:length(Evar_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Evar = Evar_cut[i]))}

all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, Evar) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "Evar", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("Evar_mean"="Evar", "Npp_Evar_mean"="prod_pred"))  

Data_ES_Evarup <- Data_ES 
Data_ES_Evarup$Evar <- Data_ES_Evarup$Evar_upper
Data_ES_upper <- Data_ES_Evarup %>% dplyr::select(S, Evar) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Evarup)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "Evar", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("Evar_upper"="Evar", "Npp_Evar_upper"="prod_pred"))  

Data_ES_Evarlow <- Data_ES 
Data_ES_Evarlow$Evar <- Data_ES_Evarlow$Evar_lower
Data_ES_lower <- Data_ES_Evarlow %>% dplyr::select(S, Evar) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Evarlow)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "Evar", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("Evar_lower"="Evar", "Npp_Evar_lower"="prod_pred"))  
#Evar_upper, Evar_lower ipv Evar and predict again. 3 predicted lines in the end: Evar high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
Global_Evar <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(Evar))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.4", "0.4-0.7", "0.7-0.9"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("Evar") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12500, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Evar_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Evar_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Evar_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###############################################################################PIE
#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*PIE + S + PIE + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(PIE~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(PIE = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                PIE_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(PIE_upper = PIE+1.96*PIE_se, PIE_lower = PIE-1.96*PIE_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

PIE_cut <- quantile(Global_Npp_Scaled$PIE, c(0.1, 0.5, 0.9), na.rm=T) #Global
PIE_cut

all_dat <- tibble()

for(i in 1:length(PIE_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(PIE = PIE_cut[i]))}

all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, PIE) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "PIE", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("PIE_mean"="PIE", "Npp_PIE_mean"="prod_pred"))  

Data_ES_PIEup <- Data_ES 
Data_ES_PIEup$PIE <- Data_ES_PIEup$PIE_upper
Data_ES_upper <- Data_ES_PIEup %>% dplyr::select(S, PIE) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_PIEup)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "PIE", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("PIE_upper"="PIE", "Npp_PIE_upper"="prod_pred"))  

Data_ES_PIElow <- Data_ES 
Data_ES_PIElow$PIE <- Data_ES_PIElow$PIE_lower
Data_ES_lower <- Data_ES_PIElow %>% dplyr::select(S, PIE) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_PIElow)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "PIE", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("PIE_lower"="PIE", "Npp_PIE_lower"="prod_pred"))  
#PIE_upper, PIE_lower ipv PIE and predict again. 3 predicted lines in the end: PIE high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
Global_PIE <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(PIE))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.1", "0.1-0.3", "0.3-0.6"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("PIE") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12500, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_PIE_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_PIE_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_PIE_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###############################################################################Pielou
#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*Pielou + S + Pielou + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(Pielou~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(Pielou = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                Pielou_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(Pielou_upper = Pielou+1.96*Pielou_se, Pielou_lower = Pielou-1.96*Pielou_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                  Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                  median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                  median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T),
                                  Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

Pielou_cut <- quantile(Global_Npp_Scaled$Pielou, c(0.1, 0.5, 0.9), na.rm=T) #Global
Pielou_cut

all_dat <- tibble()

for(i in 1:length(Pielou_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Pielou = Pielou_cut[i]))}

all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, Pielou) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "Pielou", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("Pielou_mean"="Pielou", "Npp_Pielou_mean"="prod_pred"))  

Data_ES_Pielouup <- Data_ES 
Data_ES_Pielouup$Pielou <- Data_ES_Pielouup$Pielou_upper
Data_ES_upper <- Data_ES_Pielouup %>% dplyr::select(S, Pielou) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Pielouup)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "Pielou", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("Pielou_upper"="Pielou", "Npp_Pielou_upper"="prod_pred"))  

Data_ES_Pieloulow <- Data_ES 
Data_ES_Pieloulow$Pielou <- Data_ES_Pieloulow$Pielou_lower
Data_ES_lower <- Data_ES_Pieloulow %>% dplyr::select(S, Pielou) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Pieloulow)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "Pielou", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("Pielou_lower"="Pielou", "Npp_Pielou_lower"="prod_pred"))  
#Pielou_upper, Pielou_lower ipv Pielou and predict again. 3 predicted lines in the end: Pielou high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
Global_Pielou <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(Pielou))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.6", "0.6-0.9", "0.9-1"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("Pielou") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12500, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Pielou_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Pielou_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Pielou_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###############################################################################Eq
#Model with environmental conditions
Global_Npp_Projection <- lm(Npp ~ S*Eq + S + Eq + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                               Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                 GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome), data=Global_Npp_Scaled)  

Model_ES <- gam(Eq~S, data=Global_Npp_Scaled)
Data_ES <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len=1000))) %>% mutate(Eq = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                Eq_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
                                                                         mutate(Eq_upper = Eq+1.96*Eq_se, Eq_lower = Eq-1.96*Eq_se)

#Median variables
dummy_dat <- with(Global_Npp_Scaled, tibble(S = seq(min(S), max(S), len = 1000),  TreesPerHa=median(TreesPerHa, na.rm=T),
                                            Plotsize=median(Plotsize, na.rm=T),
                                            Annual_Mean_Temperature=median(Annual_Mean_Temperature,na.rm=T),
                                            Isothermality=median(Isothermality, na.rm=T),
                                            Annual_Precipitation=median(Annual_Precipitation,na.rm=T),
                                  Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), 
                                  Sand_Content_15cm =median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm = median(pHinHOX_15cm,na.rm=T),
                                  GFAD_regrowthForestAge_Mean_downsampled50km =median(GFAD_regrowthForestAge_Mean_downsampled50km,na.rm=T),
                                  CContent_15cm =median(CContent_15cm, na.rm=T), 
                                  Human_Development_Percentage=median(Human_Development_Percentage, na.rm=T), 
                                  Population_Density =median(Population_Density, na.rm=T),
                                  Biome=as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]))

Eq_cut <- quantile(Global_Npp_Scaled$Eq, c(0.1, 0.5, 0.9), na.rm=T) #Global
Eq_cut

all_dat <- tibble()

for(i in 1:length(Eq_cut)){
  all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(Eq = Eq_cut[i]))}

all_dat$Biome <- as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]
all_dat$Biome <- as.numeric(all_dat$Biome)

all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))

Data_ES_mean <- Data_ES %>% dplyr::select(S, Eq) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.)))
Data_ES_mean <- Data_ES_mean[,c("S", "Eq", "prod_pred")]
Data_ES_mean <- rename(Data_ES_mean, c("Eq_mean"="Eq", "Npp_Eq_mean"="prod_pred"))  

Data_ES_Equp <- Data_ES 
Data_ES_Equp$Eq <- Data_ES_Equp$Eq_upper
Data_ES_upper <- Data_ES_Equp %>% dplyr::select(S, Eq) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Equp)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_upper <- Data_ES_upper[,c("S", "Eq", "prod_pred")]
Data_ES_upper <- rename(Data_ES_upper, c("Eq_upper"="Eq", "Npp_Eq_upper"="prod_pred"))  

Data_ES_Eqlow <- Data_ES 
Data_ES_Eqlow$Eq <- Data_ES_Eqlow$Eq_lower
Data_ES_lower <- Data_ES_Eqlow %>% dplyr::select(S, Eq) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_Eqlow)))) %>% mutate(Biome = as.numeric(names(sort(table(Global_Npp_Scaled$Biome), decreasing = TRUE)))[1]) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
Data_ES_lower <- Data_ES_lower[,c("S", "Eq", "prod_pred")]
Data_ES_lower <- rename(Data_ES_lower, c("Eq_lower"="Eq", "Npp_Eq_lower"="prod_pred"))  
#Eq_upper, Eq_lower ipv Eq and predict again. 3 predicted lines in the end: Eq high/low/normal

Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 

#setwd("~/Documents/PhD projects/Biomass")
#fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
#fwrite(all_datGlobal, file="GraphGlobalNPP2021.csv")

#all_datGlobal <- fread("~/Documents/PhD projects/Biomass/GraphGlobalNPP.csv")
#Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")

#Graphs
Global_Eq <- ggplot(all_datGlobal, aes(x=S, y=Npp, color=factor(Eq))) +
  geom_point() + ggtitle('Global') + theme_classic() +
  scale_colour_manual(values=c("#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("<0.1", "0.1-0.3", "0.3-0.5"), name="Evenness") +
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) + ggtitle("Eq") +
  xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(12500, 18000)) + xlim(c(0,170)) + 
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Eq_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Eq_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_Eq_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

###Adding several graphs in one figure
margin = theme(plot.margin = unit(c(0.25,0.25,0.25,0.25), "cm"))
FigS6 <- grid.arrange(Global_H1Stand, Global_Evar, Global_Simpson, Global_PIE, Global_Eq, Global_Pielou,  nrow = 2)
```



###Standard error Biomass Fig. S7 
```{r Biomass SE, include=FALSE}

Biomass_SD <- fread("GFBI_Plot_Level_with_Single_Year_Bootstrapping_subsampled_Mean_SD_Iris_20211222.csv") 
Biomass_SD$Lat <- round(Biomass_SD$Lat, digits=4)
Biomass_SD$Long <- round(Biomass_SD$Lon, digits=4)

Biomass <- fread("~/Documents/PhD projects/Biomass/Biomass20.08.2020.csv")
Biomass$TreesPerHa <- round(Biomass$treeNumber/Biomass$plotArea, 0)

#Join BiomassSD with Biomass data
BiomassSDJoin <- left_join(Biomass, Biomass_SD, by=c("Lat", "Long"))
BiomassSDSelect <- distinct(BiomassSDJoin, Plot_Nr, .keep_all = TRUE)

BiomassSD <- BiomassSDSelect[complete.cases(BiomassSDSelect), ]
dim(BiomassSD)

#BiomassSD <- Biomass %>% group_by(WWFBiome) %>% summarise(mean= mean(biomassDensity), sd=sd(log(biomassDensity))) %>% ungroup() 

set.seed(10)

nboot <- 500
all_boot <- coef_boot <- tibble()

for(k in 1:nboot){
  
  print(k)
  
  Biomass_Biome1_Global <- BiomassSD %>% filter(WWFBiome==1) %>% sample_n(2857, replace = T)
  Biomass_Biome2_Global <- BiomassSD %>% filter(WWFBiome==2) %>% sample_n(100, replace = T)
  Biomass_Biome4_Global <- BiomassSD %>% filter(WWFBiome==4) %>% sample_n(1348, replace = T)
  Biomass_Biome5_Global <- BiomassSD %>% filter(WWFBiome==5) %>% sample_n(547, replace = T)
  Biomass_Biome6_Global <- BiomassSD %>% filter(WWFBiome==6) %>% sample_n(2250, replace = T)
  Biomass_Biome7_Global <- BiomassSD %>% filter(WWFBiome==7) %>% sample_n(590, replace = T)
  Biomass_Biome8_Global <- BiomassSD %>% filter(WWFBiome==8) %>% sample_n(200, replace = T)
  Biomass_Biome9_Global <- BiomassSD %>% filter(WWFBiome==9) %>% sample_n(2, replace = T)
  Biomass_Biome10_Global <- BiomassSD %>% filter(WWFBiome==10) %>% sample_n(109, replace = T)
  Biomass_Biome11_Global <- BiomassSD %>% filter(WWFBiome==11) %>% sample_n(225, replace = T)
  Biomass_Biome12_Global <- BiomassSD %>% filter(WWFBiome==12) %>% sample_n(134, replace = T)
  Biomass_Biome13_Global <- BiomassSD %>% filter(WWFBiome==13) %>% sample_n(102, replace = T)
  
  Biomass_Global_SD <- rbind(Biomass_Biome1_Global, Biomass_Biome2_Global, Biomass_Biome4_Global, Biomass_Biome5_Global, Biomass_Biome6_Global,   Biomass_Biome7_Global, Biomass_Biome8_Global, Biomass_Biome9_Global, Biomass_Biome10_Global, Biomass_Biome11_Global, Biomass_Biome12_Global, Biomass_Biome13_Global)
  
  Biomass_SD <- Biomass_Global_SD  %>% rowwise() %>% mutate(NewBiomass = rnorm(1, mean = MeanTreeBiomassDensity, sd = SDTreeBiomassDensity)) %>% ungroup() #MeanTreeBiomassDensity*  left_join(BiomassSD, by = "Plot_Nr") %>%
  
  #plot(Biomass_SD$NewBiomass, Biomass_SD$biomassDensity)
  
  Biomass_SD$BiomassYr <- Biomass_SD$NewBiomass/Biomass_SD$ForestAge
  
  Biomass_SD <- Biomass_SD[complete.cases(Biomass_SD), ]
  
  #Projections
  DepVar <- Biomass_SD[, c("S", "WWFBiome", "Diversity", "H1", "BiomassYr", "Plotsize", "Plot_ID")]
  IndVar <- Biomass_SD[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "SecondaryForest", "ForestAge", "TreesPerHa")]
  IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data
  
  scaled <- cbind(IndVar.scaled, Biomass_SD$Plot_ID)
  setnames(scaled, old = c("Biomass_SD$Plot_ID"), new = c("Plot_ID"))
  Biomass_SD_Scaled <- merge(scaled, DepVar, by="Plot_ID")
  
  #Model with environmental conditions
  Global_Biomass_Projection <- lm(BiomassYr ~ S*H1 + S + H1 + Plotsize + TreesPerHa + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                                    Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                    ForestAge + factor(WWFBiome),data=Biomass_SD_Scaled)  
  
  Model_ES <- gam(H1~S, data=Biomass_SD_Scaled)
  Data_ES <- with(Biomass_SD_Scaled, tibble(S = seq(1, 170, len=100))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                  H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
    mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)
  
  #store coefficients
  coef_boot <- coef_boot %>% bind_rows(data.frame(Global_Biomass_Projection$coefficients[c("S", "H1", "S:H1")]) %>% setNames("value") %>% mutate(boot_rep = k, coef = rownames(.)) %>% as_tibble())
  
  #Median variables
  dummy_dat <- with(Biomass_SD_Scaled, tibble(S = seq(1, 170, len=100),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                              Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                              Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                                median(pHinHOX_15cm,na.rm=T), ForestAge = median(ForestAge, na.rm=T), CContent_15cm =
                                                median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T), WWFBiome = median(WWFBiome))) #as.numeric(names(sort(table(Biomass_SD_Scaled$WWFBiome), decreasing = TRUE)))[1]
  
  H1_cut <- c(0.4, 0.6, 0.8, 1)
  
  all_dat <- tibble()
  
  for(i in 1:length(H1_cut)){
    all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}
  
  all_dat$WWFBiome <- "7" #as.numeric(names(sort(table(Biomass_SD_Scaled$WWFBiome), decreasing = TRUE)))[1]
  all_dat$WWFBiome <- as.numeric(all_dat$WWFBiome)
    
  all_datGlobal <- all_dat %>% mutate(BiomassYr = predict(Global_Biomass_Projection, newdata = all_dat))
  
  #H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
  Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>%
    mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.)))
  Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
  Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Biomass_H1_mean"="prod_pred"))  #as.numeric(names(sort(table(Biomass_SD_Scaled$WWFBiome), decreasing = TRUE)))[1]
  
  # Data_ES_H1up <- Data_ES 
  # Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
  # Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>%
  #   mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.))) 
  # Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
  # Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Biomass_H1_upper"="prod_pred"))  
  # 
  # Data_ES_H1low <- Data_ES 
  # Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
  # Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>%
  #   mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Biomass_Projection, newdata = (.))) 
  # Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
  # Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Biomass_H1_lower"="prod_pred"))  
  
  # Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 
  Data_ES_Global <- Data_ES_mean
  
  #setwd("~/Documents/PhD projects/Biomass")
  #fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
  #fwrite(all_datTrop, file="GraphGlobalBiomass2021.csv")
  
  #all_datTemp <- fread("~/Documents/PhD projects/Biomass/GraphGlobalBiomass.csv")
  #Data_ES_Global <- fread("~/Documents/PhD projects/Biomass/Data_ES_Global.csv")
  
  #Graphs
  # maxBiomass <- Biomass_SD %>% summarise(quants = quantile(BiomassYr), probs = c(0.25)) 
  # maxBiomass <- as.data.frame(maxBiomass)
  
  all_boot <- all_boot %>% bind_rows(all_datGlobal %>% dplyr::select(S, BiomassYr, H1) %>% bind_rows(Data_ES_Global %>% dplyr::select(S, Biomass_H1_mean) %>% rename(BiomassYr = Biomass_H1_mean) %>% mutate(H1=-1)) %>% mutate(boot_rep=k))
}

boot_summ <- all_boot %>% group_by(H1, S) %>% summarize( med = median(BiomassYr), upp =quantile(BiomassYr, 0.66), low = quantile(BiomassYr, 0.33)) %>% ungroup() %>% gather(type, value, -H1, -S)

ggplot(boot_summ, aes(x = S, y = value, color = factor(H1), linetype = type))+geom_line()

GlobalGraphBiomassSEI <- ggplot(coef_boot, aes(x = value, color = coef))+geom_density(size=1)+facet_wrap(.~coef,scales = "free") + theme_classic() +
  scale_colour_manual(values=c("#0911ab", "#76bd60", "#647fed")) + ggtitle("Distribution Evenness, Richness & Interaction") + xlab("Value") + ylab("Density") + #scale_x_continuous(breaks=c(-3e+09, -1e+09, 6e+07)) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 8, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

boot_summBiomass <- boot_summ %>% mutate(LineType = if_else(type == "med", "Median", "SE"))

GlobalGraphBiomassSD <- ggplot(boot_summBiomass, aes(x=S, y=value, group = interaction(factor(H1), type), color=factor(H1), linetype=LineType)) +
  geom_line(size=0.8)+  ggtitle('Global Biomass with SE')+ theme_classic()+
  scale_colour_manual(values=c("#030303", "#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("Data", "<0.4", "0.4-0.6", "0.6-0.8", "0.8-1"), name="Evenness")+
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
  xlab("Species richness") + ylab("Biomass 1000 kg/ha yr-1") +
  scale_y_continuous(labels = function(l) {trans = l / 1000 }, limits = c(3000, 13000)) + xlim(c(0,170)) +
  #geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  #geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  #geom_smooth(data = Data_ES_Global, aes(x =S, y = Biomass_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

BiomassError <- grid.arrange(GlobalGraphBiomassSD, GlobalGraphBiomassSEI, nrow=1)

```
###Standard error NPP Fig. S7
```{r NPP SE, include=FALSE}
ProductivityFinal <- fread("~/Documents/PhD projects/Biomass/NPP_24.11.2021.csv")
ProductivityFinal <- ProductivityFinal[complete.cases(ProductivityFinal), ]

set.seed(10)
NppSD <- ProductivityFinal %>% group_by(Biome) %>% summarise(mean= mean(Npp), sd=sd(Npp)) %>% ungroup() 

nboot <- 500
all_boot <- coef_boot <- tibble()

for(k in 1:nboot){
  
  print(k)
  
Biome1_Global <- ProductivityFinal %>% filter(Biome==1) %>% sample_n(6656, replace = T)
Biome2_Global <- ProductivityFinal %>% filter(Biome==2) %>% sample_n(52, replace = T)
Biome3_Global <- ProductivityFinal %>% filter(Biome==3) %>% sample_n(214, replace = T)
Biome4_Global <- ProductivityFinal %>% filter(Biome==4) %>% sample_n(3039, replace = T)
Biome5_Global <- ProductivityFinal %>% filter(Biome==5) %>% sample_n(1233, replace = T)
Biome6_Global <- ProductivityFinal %>% filter(Biome==6) %>% sample_n(5072, replace = T)
Biome7_Global <- ProductivityFinal %>% filter(Biome==7) %>% sample_n(1405, replace = T)
Biome8_Global <- ProductivityFinal %>% filter(Biome==8) %>% sample_n(540, replace = T)
Biome9_Global <- ProductivityFinal %>% filter(Biome==9) %>% sample_n(182, replace = T)
Biome10_Global <- ProductivityFinal %>% filter(Biome==10) %>% sample_n(245, replace = T)
Biome11_Global <- ProductivityFinal %>% filter(Biome==11) %>% sample_n(506, replace = T)
Biome12_Global <- ProductivityFinal %>% filter(Biome==12) %>% sample_n(303, replace = T)
Biome13_Global <- ProductivityFinal %>% filter(Biome==13) %>% sample_n(231, replace = T)
Biome14_Global <- ProductivityFinal %>% filter(Biome==14) %>% sample_n(34, replace = T)
  
  Npp_Global_SD <- rbind(Biome1_Global, Biome2_Global, Biome3_Global, Biome4_Global, Biome5_Global, Biome6_Global, Biome7_Global, Biome8_Global, Biome9_Global, Biome10_Global, Biome11_Global, Biome12_Global, Biome13_Global, Biome14_Global)
  
  Npp_SD <- Npp_Global_SD  %>% left_join(NppSD, by = "Biome") %>% rowwise() %>% mutate(NewNpp = rnorm(1, mean =Npp, sd =sd)) %>% ungroup() #Witj + works but overfits
  
  Npp_SD$Npp <- Npp_SD$NewNpp
  
  #plot(Biomass_SD$NewBiomass, Biomass_SD$biomassDensity)
  
  Npp_SD <- Npp_SD[complete.cases(Npp_SD), ]
  
  #Projections
  DepVar <- Npp_SD[, c("S", "Biome", "Diversity", "H1", "Npp", "Plotsize", "Plot_ID")]
  IndVar <- Npp_SD[, c("Annual_Mean_Temperature", "Annual_Precipitation", "CContent_15cm", "Isothermality", "Precipitation_Seasonality", "Sand_Content_15cm", "pHinHOX_15cm", "Human_Development_Percentage", "Population_Density", "GFAD_FractionOfRegrowthForest_downsampled50km", "GFAD_regrowthForestAge_Mean_downsampled50km", "TreesPerHa")]
  IndVar.scaled <- as.data.frame(scale(IndVar)) #Scale data
  
  scaled <- cbind(IndVar.scaled, Npp_SD$Plot_ID)
  setnames(scaled, old = c("Npp_SD$Plot_ID"), new = c("Plot_ID"))
  Npp_SD_Scaled <- merge(scaled, DepVar, by="Plot_ID")
  
  #Model with environmental conditions
  Global_Npp_Projection <- lm(Npp ~ S*H1 + S + H1 + TreesPerHa + Plotsize + Annual_Mean_Temperature + Isothermality + Annual_Precipitation +
                                    Precipitation_Seasonality + Sand_Content_15cm + pHinHOX_15cm + CContent_15cm + Human_Development_Percentage + Population_Density +
                                    GFAD_regrowthForestAge_Mean_downsampled50km + factor(Biome),data=Npp_SD_Scaled)  
  
  Model_ES <- gam(H1~S, data=Npp_SD_Scaled)
  Data_ES <- with(Npp_SD_Scaled, tibble(S = seq(1, 170, len=100))) %>% mutate(H1 = predict(Model_ES, newdata = (.), se = FALSE), 
                                                                                  H1_se = predict(Model_ES, newdata = (.), se = TRUE)$se) %>%
    mutate(H1_upper = H1+1.96*H1_se, H1_lower = H1-1.96*H1_se)
  
  #store coefficients
  coef_boot <- coef_boot %>% bind_rows(data.frame(Global_Npp_Projection$coefficients[c("S", "H1", "S:H1")]) %>% setNames("value") %>% mutate(boot_rep = k, coef = rownames(.)) %>% as_tibble())
  
  #Median variables
  dummy_dat <- with(Npp_SD_Scaled, tibble(S = seq(1, 170, len=100),  TreesPerHa=median(TreesPerHa, na.rm=T), Plotsize=median(Plotsize, na.rm=T), Annual_Mean_Temperature=median(Annual_Mean_Temperature, na.rm=T),
                                              Isothermality=median(Isothermality, na.rm=T), Annual_Precipitation=median(Annual_Precipitation, na.rm=T),
                                              Precipitation_Seasonality = median(Precipitation_Seasonality, na.rm=T), Sand_Content_15cm = median(Sand_Content_15cm, na.rm=T), pHinHOX_15cm =
                                                median(pHinHOX_15cm,na.rm=T), GFAD_regrowthForestAge_Mean_downsampled50km = median(GFAD_regrowthForestAge_Mean_downsampled50km, na.rm=T), CContent_15cm =
                                                median(CContent_15cm, na.rm=T), Human_Development_Percentage = median(Human_Development_Percentage, na.rm=T), Population_Density = median(Population_Density, na.rm=T), Biome = median(Biome))) #as.numeric(names(sort(table(Npp_SD_Scaled$Biome), decreasing = TRUE)))[1]
  
  H1_cut <- c(0.4, 0.6, 0.8, 1)
  
  all_dat <- tibble()
  
  for(i in 1:length(H1_cut)){
    all_dat <- all_dat %>% bind_rows(dummy_dat %>% mutate(H1 = H1_cut[i]))}
  
  all_dat$Biome <-"7"  #as.numeric(names(sort(table(Npp_SD_Scaled$Biome), decreasing = TRUE)))[1]
  all_dat$Biome <- as.numeric(all_dat$Biome)
  
  all_datGlobal <- all_dat %>% mutate(Npp = predict(Global_Npp_Projection, newdata = all_dat))
  
  #H1_upper, H1_lower ipv H1 and predict again. 3 predicted lines in the end: H1 high/low/normal
  Data_ES_mean <- Data_ES %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES)))) %>%
    mutate(Biome = 7) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) #as.numeric(names(sort(table(Npp_SD_Scaled$Biome), decreasing = TRUE)))[1]
  Data_ES_mean <- Data_ES_mean[,c("S", "H1", "prod_pred")]
  Data_ES_mean <- rename(Data_ES_mean, c("H1_mean"="H1", "Npp_H1_mean"="prod_pred"))  
  
  # Data_ES_H1up <- Data_ES 
  # Data_ES_H1up$H1 <- Data_ES_H1up$H1_upper
  # Data_ES_upper <- Data_ES_H1up %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1up)))) %>%
  #   mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
  # Data_ES_upper <- Data_ES_upper[,c("S", "H1", "prod_pred")]
  # Data_ES_upper <- rename(Data_ES_upper, c("H1_upper"="H1", "Npp_H1_upper"="prod_pred"))  
  # 
  # Data_ES_H1low <- Data_ES 
  # Data_ES_H1low$H1 <- Data_ES_H1low$H1_lower
  # Data_ES_lower <- Data_ES_H1low %>% dplyr::select(S, H1) %>% bind_cols(dummy_dat %>% dplyr::select(-S) %>% dplyr::slice(rep(1,nrow(Data_ES_H1low)))) %>%
  #   mutate(WWFBiome = 7) %>% mutate(prod_pred = predict(Global_Npp_Projection, newdata = (.))) 
  # Data_ES_lower <- Data_ES_lower[,c("S", "H1", "prod_pred")]
  # Data_ES_lower <- rename(Data_ES_lower, c("H1_lower"="H1", "Npp_H1_lower"="prod_pred"))  
  
  # Data_ES_Global <- left_join(Data_ES_mean, Data_ES_upper, by='S') %>% left_join(., Data_ES_lower, by='S') 
  Data_ES_Global <- Data_ES_mean
  
  #setwd("~/Documents/PhD projects/Npp")
  #fwrite(Data_ES_Global, file="Data_ES_Global2021.csv")
  #fwrite(all_datTrop, file="GraphGlobalNpp2021.csv")
  
  #all_datTemp <- fread("~/Documents/PhD projects/Npp/GraphGlobalNpp.csv")
  #Data_ES_Global <- fread("~/Documents/PhD projects/Npp/Data_ES_Global.csv")
  
  #Graphs
  # maxNpp <- Npp_SD %>% summarise(quants = quantile(NppYr), probs = c(0.25)) 
  # maxNpp <- as.data.frame(maxNpp)
  
  all_boot <- all_boot %>% bind_rows(all_datGlobal %>% dplyr::select(S, Npp, H1) %>% bind_rows(Data_ES_Global %>% dplyr::select(S, Npp_H1_mean) %>% rename(Npp = Npp_H1_mean) %>% mutate(H1=-1)) %>% mutate(boot_rep=k))
}

boot_summNpp <- all_boot %>% group_by(H1, S) %>% summarize( med = median(Npp), upp =quantile(Npp, 0.66), low = quantile(Npp, 0.33)) %>% ungroup() %>% gather(type, value, -H1, -S)

#ggplot(boot_summNpp, aes(x = S, y = value, color = factor(H1), linetype = type))+geom_line()
#ggplot(coef_boot, aes(x = value, color = coef))+geom_density()+facet_wrap(.~coef,scales = "free")

GlobalGraphNPPSEI <- ggplot(coef_boot, aes(x = value, color = coef))+geom_density(size=1)+facet_wrap(.~coef,scales = "free") + theme_classic() +
  scale_colour_manual(values=c("#0911ab", "#76bd60", "#647fed")) + ggtitle("Distribution Evenness, Richness & Interaction") + xlab("Value") + ylab("Density") + #scale_x_continuous(breaks=c(-3e+09, -1e+09, 6e+07)) +
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = "none",
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 8, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

boot_summNpp <- boot_summNpp %>% mutate(LineType = if_else(type == "med", "Median", "SE"))

GlobalGraphNppSE <- ggplot(boot_summNpp, aes(x=S, y=value, group = interaction(factor(H1), type), color=factor(H1), linetype=LineType))+
  geom_line(size=0.8)+  ggtitle('Global Npp with SE')+ theme_classic()+
  scale_colour_manual(values=c("#030303", "#f5e325","#f59e25", "#f55225","#cf0a0a"), labels = c("Data", "<0.4", "0.4-0.6", "0.6-0.8", "0.8-1"), name="Evenness")+
  guides(colour = guide_legend(reverse=T, override.aes = list(size = 5))) +
   xlab("Species richness") + ylab("NPP in kg*C/m^2 yr-1") + 
  scale_y_continuous(labels = function(l) {trans = l / 10000 }, limits = c(6000, 11000)) + xlim(c(0,170)) + 
  #geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_lower), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  #geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_upper), color = "grey", method = "gam", formula = y ~ s(x, bs = "cs", k=3), se=FALSE)+
  #geom_smooth(data = Data_ES_Global, aes(x =S, y = Npp_H1_mean), color = "black", method = "gam", formula = y ~ s(x, bs = "cs", k=3))+
  theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        legend.position = c(0.2, 0.8),
        legend.title = element_text(size = 14, face = "bold"),
        legend.text=element_text(size=14), 
        axis.title.x = element_text(size = 16, face = "bold"),
        axis.text.x = element_text(size = 14, face = "bold"),
        axis.title.y = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 14, face = "bold")) 

NppError <- grid.arrange(GlobalGraphNppSE, GlobalGraphNPPSEI, nrow=1)
```

###Relationship Modis NPP and biomass change in time (multiple measurements)
```{r Modis NPP and biomass change in time, include=FALSE}

###Load Modis NPP data
setwd("~/Documents/")
evenness_biomes <- fread("~/Documents/PhD projects/Biomass/Data_productivity04042019.csv")

evenness_biomes <- evenness_biomes %>% mutate_at(vars(Lat, Long), funs(round(., 3))) #round coordinates to 3 decimals

evenness_aggregated <- evenness_biomes %>% group_by(Long, Lat) %>% summarize_all(mean) %>% as.data.frame()

###Load biomass data
biomass_data <- fread("~/Documents/PhD projects/Biomass/GFBI_Plots_with_2_More_Years_Time_Series_Records_20190312_Iris.csv")
setnames(biomass_data, old = c("LAT", "LON"), new = c("Lat", "Long"))

#Check if plotsize is the same in every plot
biomass_data <- biomass_data %>% group_by(PLT) %>%
  mutate(PlotSize = if_else(n_distinct(plotArea) > 1, "not_same_size", "same_size")) %>% as.data.frame()

biomass_data_samePs <- biomass_data[ which(biomass_data$PlotSize=='same_size'), ] #Kick out plots without the same size

biomass_data_cleaned <- biomass_data_samePs[which(biomass_data_samePs$plotArea > 0.02 & biomass_data_samePs$plotArea < 1.5),]

#Arrange data per year 
Biomass_sortedbyYear <-  biomass_data_cleaned %>% group_by(PLT) %>%
  arrange(YEAR, .by_group = TRUE) %>% as.data.frame()

#Subtract biomass values per plot
Biomass_DiffBiomass  <- Biomass_sortedbyYear %>%
  group_by(PLT) %>%
  arrange(YEAR, .by_group = TRUE) %>%
  mutate(diff_Biomass = totalBiomass - lag(totalBiomass, default = first(totalBiomass))) %>% as.data.frame()

check <-  Biomass_DiffBiomass %>% group_by(PLT) %>% filter(n()>1) 

#Subtract year intervals per plot
Biomass_DiffBiomassYr  <- Biomass_DiffBiomass %>%
  group_by(PLT) %>%
  arrange(YEAR, .by_group = TRUE) %>%
  mutate(diff_Year = YEAR - lag(YEAR, default = first(YEAR))) %>% as.data.frame()

#Divide biomass change by measurement interval
Biomass_DiffBiomassYr$Biomass_change <- Biomass_DiffBiomassYr$diff_Biomass / Biomass_DiffBiomassYr$diff_Year
Biomass_DiffBiomassYr <- as.data.frame(Biomass_DiffBiomassYr)

check1 <-  Biomass_DiffBiomassYr %>% group_by(PLT) %>% filter(n()>1) 

#Delete first rows measurements per plot
Biomass_change <- Biomass_DiffBiomassYr[Biomass_DiffBiomassYr$diff_Year != 0, ]

#Subtract biomass change and number of measurements
Biomass_change <-  Biomass_change %>% group_by(PLT) %>% mutate(Biomass_change_Yr = (sum(Biomass_change)/diff_Year)) %>% as.data.frame()

#Merge data
biomass_change <- Biomass_change %>% mutate_at(vars(Lat, Long), funs(round(., 3))) #round coordinates to 3 decimals
biomass_change <- biomass_change[, -c(2,16)]

Biomass_year_aggregated <- biomass_change %>% group_by(Lat, Long) %>% summarize_all(mean) %>% as.data.frame()

Productivity_change <-merge(Biomass_year_aggregated, evenness_aggregated, by=c("Lat", "Long"))
Productivity_change <- Productivity_change[complete.cases(Productivity_change), ]

#Only select plots with biomass gain in time
Productivity_change <- subset(Productivity_change, Biomass_change_Yr >0) 

#Select 95% of data per biome, to get rid of outliers
Productivity_change <- Productivity_change %>% group_by(WWF_Biome_reduced) %>% filter(totalBiomass > (mean(totalBiomass) -  2*(sd(totalBiomass))) & totalBiomass < (mean(totalBiomass) + 2*(sd(totalBiomass)))) 

#Select only complete rows
Productivity_final <- Productivity_change[complete.cases(Productivity_change), ]

#####CHECK IF NPP LAYERS SHOWS SAME TREND
Productivity_subset <- subset(Productivity_final, Biomass_change_Yr >0 & Biomass_change_Yr <1500)
cor.test(Productivity_subset$Npp, Productivity_subset$Biomass_change_Yr, method= "pearson") #correlation coefficient of 0.66, p-value < 2.2e-16
cor.test(Productivity_subset$Npp, Productivity_subset$Biomass_change_Yr, method= "spearman") 


```